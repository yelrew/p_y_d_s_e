<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>pydse.powergrid &mdash; PyDSE 1.1 documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../index.html" class="icon icon-home"> PyDSE
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../modules.html">pydse</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">PyDSE</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../index.html">Module code</a> &raquo;</li>
          <li><a href="../pydse.html">pydse</a> &raquo;</li>
      <li>pydse.powergrid</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for pydse.powergrid</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;A class to represent a bus-branch model of a power system&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">pydse</span> <span class="kn">import</span> <span class="n">pyopendss</span> <span class="k">as</span> <span class="n">dss</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">numpy</span> <span class="kn">import</span> <span class="n">NaN</span><span class="p">,</span> <span class="n">pi</span>
<span class="kn">import</span> <span class="nn">pint</span> <span class="c1"># unit conversion</span>
<span class="kn">import</span> <span class="nn">networkx</span> <span class="k">as</span> <span class="nn">nx</span> <span class="c1"># graphs manipulation</span>


<div class="viewcode-block" id="Powergrid"><a class="viewcode-back" href="../../pydse.html#pydse.powergrid.Powergrid">[docs]</a><span class="k">class</span> <span class="nc">Powergrid</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot; A class to represent a bus-branch model of a power system.</span>

<span class="sd">    Models for elements of power distribution and conversion: lines, </span>
<span class="sd">    transformers, regulators, capacitors and loads. </span>
<span class="sd">    All components are handled in a per-node basis, which enables the class </span>
<span class="sd">    to natively represent a natural (unbalanced) power network.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    circuit : `dict` [`str`, `dict`]</span>
<span class="sd">        Represents a multi-phase voltage source. The key `str` is the circuit</span>
<span class="sd">        (source) name. The internal subkeys (properties) can be as follows:</span>

<span class="sd">        ``bus1`` : `str`</span>
<span class="sd">            Name of the source bus</span>
<span class="sd">        ``basekv`` : `str`</span>
<span class="sd">            rated Line-to-line kV</span>
<span class="sd">        ``pu`` : `str`</span>
<span class="sd">            Actual per unit operating voltage</span>
<span class="sd">        ``angle`` : `str`</span>
<span class="sd">            Base angle of the first phase (in degrees)</span>
<span class="sd">        ``MVAsc3`` : `str`</span>
<span class="sd">            3-phase short circuit MVA</span>
<span class="sd">        ``MVAsc1`` : `str`</span>
<span class="sd">            1-phase short circuit MVA</span>

<span class="sd">    line : `dict` [`str`, `dict`]</span>
<span class="sd">        Represents a multi-phase line or cable. The key `str` is the line name.</span>
<span class="sd">        The subkeys of the internal `dict` are:        </span>

<span class="sd">        ``bus1`` : `str`</span>
<span class="sd">            Name of bus and the correponding nodes of terminal 1.</span>
<span class="sd">            The nodes should be provided in the following way: &#39;bus.1.2.3&#39;</span>
<span class="sd">            If missing, the  phase sequence &#39;123&#39; is assumed.</span>
<span class="sd">        ``bus2`` : `str`</span>
<span class="sd">            Name of bus and the correponding nodes of terminal 2</span>
<span class="sd">        ``Linecode`` : `str`, optional</span>
<span class="sd">            Name of the associated `linecode` object with impedance definitions</span>
<span class="sd">        ``Length`` : `str`</span>
<span class="sd">            Line length</span>
<span class="sd">        ``R1, X1, R0, X0`` : `str`</span>
<span class="sd">            Positive and zero-sequence resistances, and reactances, in</span>
<span class="sd">            ohms per unit length.</span>
<span class="sd">        ``C1, C0`` : `str`            </span>
<span class="sd">            Positive and zero-sequence capacitances (nF / unit length)</span>
<span class="sd">        ``units`` : `str`</span>
<span class="sd">            Length units.</span>

<span class="sd">    transformer : `dict` [`str`, `dict`]</span>
<span class="sd">        Represents a three- or single-phase transformer. The key is the </span>
<span class="sd">        element name. The main properties are:   </span>

<span class="sd">        ``Phases`` : `str`</span>
<span class="sd">            Number of phases</span>
<span class="sd">        ``Windings`` : `str`</span>
<span class="sd">            Number of windings</span>
<span class="sd">        ``XHL`` : `str`</span>
<span class="sd">            Percent high-to-low reactance</span>

<span class="sd">        The following properties are read sequentially, for each winding:    </span>

<span class="sd">        ``Wdg`` : `str`</span>
<span class="sd">            Winding integer identification</span>
<span class="sd">        ``Bus`` : `str`</span>
<span class="sd">            Bus (and nodes) to which the winding is conneted</span>
<span class="sd">        ``Conn`` : { &#39;wye&#39;, &#39;delta&#39; }</span>
<span class="sd">            Connection type of the winding</span>
<span class="sd">        ``kV`` : `str`</span>
<span class="sd">            Rated kV</span>
<span class="sd">        ``kva`` : `str`</span>
<span class="sd">            Base kva rating of the winding</span>
<span class="sd">        ``%R`` : `str`</span>
<span class="sd">            Percent resistance on the rated kva base</span>
<span class="sd">        ``%Tap`` : `str`</span>
<span class="sd">            Per-unit tap of the winding</span>

<span class="sd">        Alternatively, the previous properties can be set for </span>
<span class="sd">        all windings at once, by using the following keys:</span>

<span class="sd">        ``Buses`` : `str` (array_like)</span>
<span class="sd">            Array of bus-nodes definitions</span>
<span class="sd">        ``Conns`` : `str` (array_like)</span>
<span class="sd">            Array of winding connections</span>
<span class="sd">        ``kVs`` : `str` (array_like)</span>
<span class="sd">            Array of rated kVs</span>
<span class="sd">        ``kvas`` : `str`</span>
<span class="sd">            Array of the rated kvas</span>
<span class="sd">        ``Taps`` : `str`</span>
<span class="sd">            Array of per-unit taps</span>
<span class="sd">        ``%Rs`` : `str`</span>
<span class="sd">            Array of percent resistances</span>

<span class="sd">    regcontrol : `dict` [`str`, `dict`]           </span>
<span class="sd">        Voltage regulator model (currenly not used by PYDSE)</span>

<span class="sd">    load : `dict` [`str`, `dict`]</span>
<span class="sd">        Multi-phase load model. The key `str` is the load identification.</span>
<span class="sd">        The internal properties are:</span>

<span class="sd">        ``bus1`` : `str`</span>
<span class="sd">            Name of the bus (and nodes) to which the load is connected.</span>
<span class="sd">        ``Phases`` : `str` (int like)</span>
<span class="sd">            Number of phases</span>
<span class="sd">        ``kV`` : `str` (float like)</span>
<span class="sd">            Nominal voltage.</span>
<span class="sd">        ``kW`` : `str` (float like)</span>
<span class="sd">            Nominal active power</span>
<span class="sd">        ``kvar`` : `str` (float like)</span>
<span class="sd">            Base kvar</span>
<span class="sd">        ``Model`` : {&#39;1&#39;, &#39;2&#39; , &#39;5&#39;}, where:</span>
<span class="sd">            1 is Constant power</span>
<span class="sd">            2 is Constant admittance</span>
<span class="sd">            5 is Constant current</span>
<span class="sd">        ``Conn`` : {&#39;wye&#39;, &#39;delta&#39;}</span>
<span class="sd">            Connection type.            </span>

<span class="sd">    capacitor : `dict` [`str`, `dict`]</span>
<span class="sd">        Shunt (grounded) capacitor model. The key `str` is the element name.</span>
<span class="sd">        The properties are:</span>

<span class="sd">        ``bus1`` : `str`</span>
<span class="sd">            Name of the bus (and nodes) to which the element is connected.</span>
<span class="sd">        ``Phases`` : `str` (int like)</span>
<span class="sd">            Number of phases</span>
<span class="sd">        ``kV`` : `str` (float like)</span>
<span class="sd">            Rated kv</span>
<span class="sd">        ``kVar`` : `str` (float like)</span>
<span class="sd">            Rated kvar (total of all phases)</span>

<span class="sd">    branches : `dict` [`str`, `dict`]</span>
<span class="sd">        Associative array where the keys are the branch elements and the</span>
<span class="sd">        values are the processed parameters</span>
<span class="sd">    busnodes : `dict` [`str`, `dict`]</span>
<span class="sd">        Associative array where the keys are the bus numbers, and the values</span>
<span class="sd">        are the numering indices associated to each node.</span>
<span class="sd">        This array defines the bus-node order of the voltage and current arrays.</span>
<span class="sd">    orderbus : `dict` [`str, `int`]</span>
<span class="sd">        Array mapping bus names and the corresponding order position.</span>
<span class="sd">    orderbusn : `dict` [`str, `int`]</span>
<span class="sd">        Array mapping bus names with nodes and the corresponding order position.    </span>

<span class="sd">    nbus : `int`</span>
<span class="sd">        Total number of buses</span>
<span class="sd">    nnodes : `int`</span>
<span class="sd">        Total number of nodes</span>
<span class="sd">    nbr : `int`</span>
<span class="sd">        Number of branches</span>
<span class="sd">    nbrp : `int`</span>
<span class="sd">        Number of individual branches      </span>
<span class="sd">    dss : `pyopendss.Dss` object, default None</span>
<span class="sd">        It will have the Dss object when readfromdss is called.</span>
<span class="sd">    sysname : `str`</span>
<span class="sd">        Name of the network, as read in the circuit attribute.</span>
<span class="sd">    filepath : `str`</span>
<span class="sd">        Stores the filename the system data was read from.</span>
<span class="sd">    sub_bus : `str`</span>
<span class="sd">        Name of the substation (source) bus, as read in `circuit` attribute.</span>
<span class="sd">    sub_nph : `int` </span>
<span class="sd">        Number of phases in the substation</span>
<span class="sd">    sub_kv : `float`</span>
<span class="sd">        Voltage level of the substation   </span>

<span class="sd">    E, I, S : `numpy.array` (`nnodes`,)</span>
<span class="sd">        Complex nodal voltages (line-to-neutral), currents and power injections </span>
<span class="sd">        injections, of size `nnodes`.</span>
<span class="sd">    Ell : `numpy.array`</span>
<span class="sd">        Complex Line-to-line voltages</span>
<span class="sd">    Ikm, Skm : `numpy.array` of `complex` type, (`nbrp`,)    </span>
<span class="sd">        Complex branch currents and power flows </span>
<span class="sd">    Y : `numpy.array` of `complex` (`nnodes`, `nnodes`)</span>
<span class="sd">        Complex Admittance Matrix</span>
<span class="sd">    H : `networkx.MultiDiGraph`        </span>
<span class="sd">        Graph of the network.</span>
<span class="sd">    sweepfromroot : `networkx.DiGraph`        </span>
<span class="sd">        Orderd Graph that will hold the branches ordered with respect to</span>
<span class="sd">        the substation distance (see `calc_Vbase` for more detauls)</span>
<span class="sd">    vbase : `numpy.array` (`nnodes`,)</span>
<span class="sd">        Voltage base defined for each node (see `calc_Vbase`)</span>
<span class="sd">    initv : `numpy.array` (`nnodes`,)</span>
<span class="sd">        Per-unit complex number assigned to each node , for initialization</span>
<span class="sd">        purposes (see `calc_Vbase` for more details)</span>
<span class="sd">    trbus1 : `list` [`str`]</span>
<span class="sd">        List of transformers&#39; primary buses</span>
<span class="sd">    trbus2 : `list` [`str`]</span>
<span class="sd">        List of transformers&#39; secondary buses        </span>
<span class="sd">    times : `bool`, default False</span>
<span class="sd">        Enables time measuring, if True</span>
<span class="sd">    times_data : `dict` [`str`, `float`]</span>
<span class="sd">        Array where the keys are function markers and the values</span>
<span class="sd">        are the corresponding computing times (enabled if `times` is True)            </span>

<span class="sd">    Note</span>
<span class="sd">    ----</span>
<span class="sd">    Example of valid bus identifiers:</span>

<span class="sd">    ``300.1.2.3`` (bus 300 with nodes 1, 2 and 3)</span>

<span class="sd">    ``400.1.2`` (bus 400 with nodes 1 and 2)</span>

<span class="sd">    ``SRC`` (bus SRC, with nodes 1 to 3 depending on the number of phases)         </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">circuit</span><span class="o">=</span><span class="p">{},</span> <span class="n">line</span><span class="o">=</span><span class="p">{},</span> <span class="n">linecode</span><span class="o">=</span><span class="p">{},</span> <span class="n">transformer</span><span class="o">=</span><span class="p">{},</span>
                 <span class="n">regcontrol</span><span class="o">=</span><span class="p">{},</span> <span class="n">load</span><span class="o">=</span><span class="p">{},</span> <span class="n">capacitor</span><span class="o">=</span><span class="p">{},</span>
                 <span class="n">sbase</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">times</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initiates an (empy) power grid object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">circuit</span> <span class="o">=</span> <span class="n">circuit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">line</span> <span class="o">=</span> <span class="n">line</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">linecode</span> <span class="o">=</span> <span class="n">linecode</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transformer</span> <span class="o">=</span> <span class="n">transformer</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">regcontrol</span> <span class="o">=</span> <span class="n">regcontrol</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">load</span> <span class="o">=</span> <span class="n">load</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">capacitor</span> <span class="o">=</span> <span class="n">capacitor</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">sbase</span> <span class="o">=</span> <span class="n">sbase</span> <span class="c1"># enables per-unit computation (experimental)!</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dss</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># dss object (if)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">busnodes</span> <span class="o">=</span> <span class="p">{}</span> <span class="c1"># dictionary with buses and node sequences and indexes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">branches</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nbr</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># number of branches (lines and transformers)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nbrp</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># number of branches including all phases</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nbus</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># number of buses</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nnodes</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># number of nodes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dss</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># dss object (if the data is read from .DSS file)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sysname</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># short name of the circuit (from circuit dict)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filepath</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># data file associated with the grid</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">I</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># Nodal (complex) currents (dimension: nnodes)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">E</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># Nodal (complex) voltages, phase-to-neutrao (dimension: nnodes)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Ikm</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># Branch currents in each branch (each onde including all phases)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Skm</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># Power flows</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">S</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># Nodal Power Injections</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Ell</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># Nodal (complex) voltages, line-to-line (dimension: nnodes)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Y</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># Admittance matrix (size: nnodes x nnodes)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">H</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">MultiDiGraph</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initv</span> <span class="o">=</span> <span class="p">{}</span> <span class="c1"># Vector with the voltage level drop with related to the substation (1pu) (traversed)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vbase</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># Vector with node bases</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">orderbusn</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1">#[ &#39;650.1.2.3&#39;, &#39;675.1.2.3&#39;, &#39;670.1.2.3&#39;, &#39;632.1.2.3&#39;, &#39;671.1.2.3&#39; ]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">orderbus</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># Will have the final bus order (only buses)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sub_bus</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># Identification of the substation (circuit) bus</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sub_nph</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># Number of phases in the substation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sub_kv</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># Voltage level of the substation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sweepfromroot</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># Graph that will contain the sweep branch order from the root bus</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trbus1</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># Primary transformers buses list</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trbus2</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># Secondary transformers buses list</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">times</span> <span class="o">=</span> <span class="n">times</span> <span class="c1"># Enable time measuring</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">times_data</span> <span class="o">=</span> <span class="p">{}</span> <span class="c1"># Time data</span>

<div class="viewcode-block" id="Powergrid.fromdss"><a class="viewcode-back" href="../../pydse.html#pydse.powergrid.Powergrid.fromdss">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">fromdss</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">filepath</span><span class="p">,</span> <span class="n">sbase</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">times</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Creates a Powergrid object from an OpenDSS data file</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        filepath : `str`</span>
<span class="sd">            Path of the OpenDSS file</span>
<span class="sd">        sbase : `float`, optional</span>
<span class="sd">            Nominal power base (experimental)</span>
<span class="sd">        times : bool, optional</span>
<span class="sd">            Activate the meausuring of computing times, by default False</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">times</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">time</span>
            <span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">_dss</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">Dss</span><span class="p">()</span>
        <span class="n">_dss</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>
        <span class="n">_self</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span><span class="n">_dss</span><span class="o">.</span><span class="n">circuit</span><span class="p">,</span> <span class="n">_dss</span><span class="o">.</span><span class="n">line</span><span class="p">,</span> <span class="n">_dss</span><span class="o">.</span><span class="n">linecode</span><span class="p">,</span> <span class="n">_dss</span><span class="o">.</span><span class="n">transformer</span><span class="p">,</span>
                    <span class="n">_dss</span><span class="o">.</span><span class="n">regcontrol</span><span class="p">,</span><span class="n">_dss</span><span class="o">.</span><span class="n">load</span><span class="p">,</span><span class="n">_dss</span><span class="o">.</span><span class="n">capacitor</span><span class="p">,</span> <span class="n">sbase</span><span class="p">,</span> <span class="n">times</span><span class="p">)</span>

        <span class="n">_self</span><span class="o">.</span><span class="n">sysname</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">_dss</span><span class="o">.</span><span class="n">circuit</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">_self</span><span class="o">.</span><span class="n">filepath</span> <span class="o">=</span> <span class="n">filepath</span>
        <span class="n">_self</span><span class="o">.</span><span class="n">dss</span> <span class="o">=</span> <span class="n">_dss</span>

        <span class="k">if</span> <span class="n">times</span><span class="p">:</span>
            <span class="n">_self</span><span class="o">.</span><span class="n">times_data</span><span class="p">[</span><span class="s1">&#39;Creation of powergrid from OpenDSS file ~ grid.from_dss()&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">t0</span>                

        <span class="k">return</span><span class="p">(</span><span class="n">_self</span><span class="p">)</span></div>

<div class="viewcode-block" id="Powergrid.busbranch"><a class="viewcode-back" href="../../pydse.html#pydse.powergrid.Powergrid.busbranch">[docs]</a>    <span class="k">def</span> <span class="nf">busbranch</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Build the bus-branch model of the network</span>

<span class="sd">        The bus-branch representation of the system is defined in terms of </span>
<span class="sd">        nodes and edges, which are modeled in the `busnodes` and `branches` </span>
<span class="sd">        associative arrays. The representation of most elements of the system </span>
<span class="sd">        follows the OpenDSS standard.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        1) The following equipment are currently accepted: </span>

<span class="sd">            - multi-phase lines</span>
<span class="sd">            - multi-phase transformers</span>
<span class="sd">            - multi-phase capacitors (assumed as current injections)</span>

<span class="sd">            The parameters are included in its original states (ohms, siemens, </span>
<span class="sd">            and so forth). The series and shunt line parameters can be provided </span>
<span class="sd">            in terms of impedance matrices or sequency matrices.</span>

<span class="sd">        2) The order assumed for each bus and nodes is defined according to the</span>
<span class="sd">           branch reading sequence (lines then transformers). The `orderbus` and</span>
<span class="sd">           `orderbusn` hold the bus-node sequence for subsequent references.</span>
<span class="sd">        &quot;&quot;&quot;</span>                
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nnodes</span> <span class="o">!=</span><span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">times</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">time</span>
            <span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        
        <span class="n">series_elements</span> <span class="o">=</span> <span class="p">[]</span>        
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">line</span><span class="p">):</span> 
            <span class="n">series_elements</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;line&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">transformer</span><span class="p">):</span> 
            <span class="n">series_elements</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;transformer&#39;</span><span class="p">)</span>

        <span class="c1"># The subtation bus is the first bus in &#39;busnodes&#39; structure</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sub_bus</span><span class="p">,</span> <span class="o">*</span><span class="n">sub_nodes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">circuit</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">sysname</span><span class="p">][</span><span class="s1">&#39;bus1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>      
        <span class="bp">self</span><span class="o">.</span><span class="n">sub_nph</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">circuit</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">sysname</span><span class="p">][</span><span class="s1">&#39;phases&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sub_kv</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">circuit</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">sysname</span><span class="p">][</span><span class="s1">&#39;basekv&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sub_angle</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">circuit</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">sysname</span><span class="p">][</span><span class="s1">&#39;angle&#39;</span><span class="p">])</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">180</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">sub_angles</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span> <span class="p">[</span> <span class="n">np</span><span class="o">.</span><span class="n">e</span><span class="o">**</span><span class="p">(</span><span class="mi">1</span><span class="n">j</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">sub_angle</span><span class="p">),</span> 
                                            <span class="n">np</span><span class="o">.</span><span class="n">e</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="n">j</span><span class="o">*</span><span class="p">(</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">sub_angle</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">pi</span><span class="o">/</span><span class="mi">3</span><span class="p">)),</span> 
                                            <span class="n">np</span><span class="o">.</span><span class="n">e</span><span class="o">**</span><span class="p">(</span> <span class="mi">1</span><span class="n">j</span><span class="o">*</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">sub_angle</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">pi</span><span class="o">/</span><span class="mi">3</span><span class="p">))</span> <span class="p">]</span> <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">busnodes</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">sub_bus</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">busnodes</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">sub_bus</span><span class="p">][</span><span class="s1">&#39;nphases&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sub_nph</span> <span class="c1"># filling number of phases</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">busnodes</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">sub_bus</span><span class="p">][</span><span class="s1">&#39;nodes&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sub_nodes</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">H</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sub_bus</span><span class="p">)</span> <span class="c1"># making sub_bus the root node</span>

        <span class="n">ureg</span> <span class="o">=</span> <span class="n">pint</span><span class="o">.</span><span class="n">UnitRegistry</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">series_elements</span><span class="p">:</span> <span class="c1"># process all kind of series elements           </span>
            <span class="n">elements</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="s1">&#39;self.&#39;</span> <span class="o">+</span> <span class="n">s</span><span class="p">)</span> <span class="c1"># group of identical elements (transformers or lines)           </span>

            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">element</span> <span class="ow">in</span> <span class="n">elements</span><span class="o">.</span><span class="n">items</span><span class="p">():</span> <span class="c1"># looping over individual line or transformer element</span>
                <span class="n">bus_tag</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">element</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="k">if</span> <span class="s2">&quot;bus1&quot;</span> <span class="ow">in</span> <span class="n">x</span> <span class="ow">or</span> <span class="s2">&quot;bus2&quot;</span> <span class="ow">in</span> <span class="n">x</span><span class="p">]</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">bus_tag</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Error: Bus1 or Bus2 missing in &#39;</span> <span class="o">+</span> <span class="n">s</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">key</span><span class="p">)</span>
                    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

                <span class="c1"># Filling branch data</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">branches</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">bus1</span><span class="p">,</span> <span class="o">*</span><span class="n">nodes1</span> <span class="o">=</span> <span class="n">element</span><span class="p">[</span><span class="s1">&#39;bus1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
                <span class="n">bus2</span><span class="p">,</span> <span class="o">*</span><span class="n">nodes2</span> <span class="o">=</span> <span class="n">element</span><span class="p">[</span><span class="s1">&#39;bus2&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
                <span class="n">nodes1</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">nodes1</span><span class="p">)</span>
                <span class="n">nodes2</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">nodes2</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">branches</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;bus1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bus1</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">branches</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;nodes1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nodes1</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">branches</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;bus2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bus2</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">branches</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;nodes2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nodes2</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">branches</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">s</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">branches</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;phases&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">element</span><span class="p">[</span><span class="s1">&#39;phases&#39;</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">nbrp</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">branches</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;phases&#39;</span><span class="p">]</span> <span class="c1"># each phase contributes to one element to the connectivity matrix  </span>

                <span class="c1"># Including line data</span>

                <span class="k">if</span> <span class="n">s</span> <span class="o">==</span> <span class="s1">&#39;line&#39;</span><span class="p">:</span>
                    <span class="c1"># before copying the branch impedance, match the line and linecode units                    </span>
                    <span class="k">if</span> <span class="n">element</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]:</span>
                        <span class="n">line_units</span> <span class="o">=</span> <span class="n">element</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span>                        
                        <span class="n">linecode_units</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">linecode</span><span class="p">[</span><span class="n">element</span><span class="p">[</span><span class="s1">&#39;linecode&#39;</span><span class="p">]][</span><span class="s1">&#39;units&#39;</span><span class="p">]</span>
                        <span class="n">uf</span> <span class="o">=</span> <span class="n">ureg</span><span class="o">.</span><span class="n">Quantity</span><span class="p">(</span><span class="n">line_units</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">linecode_units</span><span class="p">)</span><span class="o">.</span><span class="n">_magnitude</span> <span class="c1"># unit conversion factor</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">uf</span> <span class="o">=</span> <span class="mf">1.</span>
                
                    <span class="k">if</span> <span class="s1">&#39;*&#39;</span> <span class="ow">in</span> <span class="n">element</span><span class="p">[</span><span class="s1">&#39;length&#39;</span><span class="p">]:</span>
                        <span class="n">multx</span> <span class="o">=</span> <span class="n">element</span><span class="p">[</span><span class="s1">&#39;length&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
                        <span class="n">length</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">multx</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="nb">float</span><span class="p">(</span><span class="n">multx</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">length</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">element</span><span class="p">[</span><span class="s1">&#39;length&#39;</span><span class="p">])</span>

                    <span class="k">if</span> <span class="s1">&#39;linecode&#39;</span> <span class="ow">in</span> <span class="n">element</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">branches</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;rmatrix&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">length</span> <span class="o">*</span> <span class="n">uf</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">linecode</span><span class="p">[</span><span class="n">element</span><span class="p">[</span><span class="s1">&#39;linecode&#39;</span><span class="p">]][</span><span class="s1">&#39;rmatrix_np&#39;</span><span class="p">]</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">branches</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;xmatrix&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">length</span> <span class="o">*</span> <span class="n">uf</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">linecode</span><span class="p">[</span><span class="n">element</span><span class="p">[</span><span class="s1">&#39;linecode&#39;</span><span class="p">]][</span><span class="s1">&#39;xmatrix_np&#39;</span><span class="p">]</span>                        

                        <span class="k">if</span> <span class="s1">&#39;cmatrix_np&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">linecode</span><span class="p">[</span><span class="n">element</span><span class="p">[</span><span class="s1">&#39;linecode&#39;</span><span class="p">]]:</span> 
                            <span class="bp">self</span><span class="o">.</span><span class="n">branches</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;cmatrix&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="n">length</span> <span class="o">*</span> <span class="n">uf</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">linecode</span><span class="p">[</span><span class="n">element</span><span class="p">[</span><span class="s1">&#39;linecode&#39;</span><span class="p">]][</span><span class="s1">&#39;cmatrix_np&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1e-9</span> <span class="c1"># [nF/unit length]</span>
                            <span class="k">if</span> <span class="s1">&#39;basefreq&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">linecode</span><span class="p">[</span><span class="n">element</span><span class="p">[</span><span class="s1">&#39;linecode&#39;</span><span class="p">]]:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">branches</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;basefreq&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">linecode</span><span class="p">[</span><span class="n">element</span><span class="p">[</span><span class="s1">&#39;linecode&#39;</span><span class="p">]][</span><span class="s1">&#39;basefreq&#39;</span><span class="p">])</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">branches</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;basefreq&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">60</span> <span class="c1"># default frequency</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># Sequence matrix were given</span>

                        <span class="k">if</span> <span class="n">element</span><span class="p">[</span><span class="s1">&#39;phases&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;1&#39;</span><span class="p">:</span>
                            <span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;Error in busbranch: linecode wasn&#39;&#39;t given but nphases=1&#39;</span><span class="p">)</span>
                            <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

                        <span class="n">a</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">+</span> <span class="mi">1</span><span class="n">j</span><span class="o">*</span><span class="mi">3</span><span class="o">**</span><span class="mf">0.5</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
                        <span class="n">A</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">],[</span><span class="mi">1</span><span class="p">,</span><span class="n">a</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">a</span><span class="p">],[</span><span class="mi">1</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">a</span><span class="o">**</span><span class="mi">2</span><span class="p">]])</span>
                        <span class="n">Ai</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="mi">3</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">],[</span><span class="mi">1</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">a</span><span class="o">**</span><span class="mi">2</span><span class="p">],[</span><span class="mi">1</span><span class="p">,</span><span class="n">a</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">a</span><span class="p">]])</span>

                        <span class="k">if</span> <span class="s1">&#39;r1&#39;</span> <span class="ow">in</span> <span class="n">element</span><span class="p">:</span>
                            <span class="n">z1</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">element</span><span class="p">[</span><span class="s1">&#39;r1&#39;</span><span class="p">])</span>
                        <span class="k">if</span> <span class="s1">&#39;x1&#39;</span> <span class="ow">in</span> <span class="n">element</span><span class="p">:</span>
                            <span class="k">if</span> <span class="s1">&#39;r1&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">element</span><span class="p">:</span>
                                <span class="n">z1</span> <span class="o">=</span> <span class="mi">0</span>
                            <span class="n">z1</span> <span class="o">=</span> <span class="n">z1</span> <span class="o">+</span> <span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="nb">float</span><span class="p">(</span><span class="n">element</span><span class="p">[</span><span class="s1">&#39;x1&#39;</span><span class="p">])</span>
                        <span class="k">if</span> <span class="s1">&#39;r0&#39;</span> <span class="ow">in</span> <span class="n">element</span><span class="p">:</span>
                            <span class="n">z0</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">element</span><span class="p">[</span><span class="s1">&#39;r0&#39;</span><span class="p">])</span>                            
                        <span class="k">if</span> <span class="s1">&#39;x0&#39;</span> <span class="ow">in</span> <span class="n">element</span><span class="p">:</span>
                            <span class="k">if</span> <span class="s1">&#39;r0&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">element</span><span class="p">:</span>
                                <span class="n">z0</span> <span class="o">=</span> <span class="mi">0</span>
                            <span class="n">z0</span> <span class="o">=</span> <span class="n">z0</span> <span class="o">+</span> <span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="nb">float</span><span class="p">(</span><span class="n">element</span><span class="p">[</span><span class="s1">&#39;x0&#39;</span><span class="p">])</span>

                        <span class="n">Z012</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">z0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="n">z1</span><span class="p">,</span><span class="mi">0</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">z1</span><span class="p">]])</span>
                        <span class="n">Z</span> <span class="o">=</span> <span class="n">A</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Z012</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Ai</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">branches</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;rmatrix&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Z</span><span class="o">.</span><span class="n">real</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">branches</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;xmatrix&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Z</span><span class="o">.</span><span class="n">imag</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">branches</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;zkm&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">branches</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;rmatrix&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="n">j</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">branches</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;xmatrix&#39;</span><span class="p">]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">branches</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;ykm&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">branches</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;zkm&#39;</span><span class="p">])</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">branches</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;At&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">element</span><span class="p">[</span><span class="s1">&#39;phases&#39;</span><span class="p">]))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">branches</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;akm&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.</span>
                    <span class="n">weight</span> <span class="o">=</span> <span class="mf">1.</span> <span class="c1"># to Calc_Vbase                    </span>

                <span class="c1"># Including transformers data</span>

                <span class="k">elif</span> <span class="n">s</span> <span class="o">==</span> <span class="s1">&#39;transformer&#39;</span><span class="p">:</span>

                    <span class="k">if</span> <span class="s1">&#39;/&#39;</span> <span class="ow">in</span> <span class="n">element</span><span class="p">[</span><span class="s1">&#39;xhl&#39;</span><span class="p">]:</span>
                        <span class="n">divx</span> <span class="o">=</span> <span class="n">element</span><span class="p">[</span><span class="s1">&#39;xhl&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
                        <span class="n">xeq_percent</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">divx</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">divx</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">xeq_percent</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">element</span><span class="p">[</span><span class="s1">&#39;xhl&#39;</span><span class="p">])</span>

                    <span class="k">if</span> <span class="s1">&#39;</span><span class="si">%lo</span><span class="s1">adloss&#39;</span> <span class="ow">in</span> <span class="n">element</span><span class="p">:</span>
                        <span class="n">req_percent</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">element</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">%lo</span><span class="s1">adloss&#39;</span><span class="p">])</span>
                    <span class="k">elif</span> <span class="s1">&#39;</span><span class="si">%r</span><span class="s1">s&#39;</span> <span class="ow">in</span> <span class="n">element</span><span class="p">:</span>
                        <span class="n">req_percent</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">element</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">%r</span><span class="s1">s&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">())</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
                    <span class="k">elif</span> <span class="s1">&#39;</span><span class="si">%r</span><span class="s1">&#39;</span> <span class="ow">in</span> <span class="n">element</span><span class="p">:</span>
                        <span class="k">if</span> <span class="s1">&#39;/&#39;</span> <span class="ow">in</span> <span class="n">element</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">%r</span><span class="s1">&#39;</span><span class="p">]:</span>
                            <span class="n">divr</span> <span class="o">=</span> <span class="n">element</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">%r</span><span class="s1">&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
                            <span class="n">req_percent</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">divr</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">divr</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">req_percent</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">element</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">%r</span><span class="s1">&#39;</span><span class="p">])</span> <span class="o">+</span> <span class="nb">float</span><span class="p">(</span><span class="n">element</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">%r</span><span class="s1">.1&#39;</span><span class="p">])</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">req_percent</span> <span class="o">=</span> <span class="mf">0.4</span> <span class="c1"># magic OpenDSS number :)</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">branches</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;%zeq&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">req_percent</span> <span class="o">+</span> <span class="mi">1</span><span class="n">j</span><span class="o">*</span><span class="n">xeq_percent</span>

                    <span class="k">if</span> <span class="s1">&#39;buses&#39;</span> <span class="ow">in</span> <span class="n">element</span><span class="p">:</span>                   
                        <span class="n">kv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">element</span><span class="p">[</span><span class="s1">&#39;kvs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">())</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
                        <span class="n">kva</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">element</span><span class="p">[</span><span class="s1">&#39;kvas&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">())</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
                        <span class="n">tap</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">element</span><span class="p">[</span><span class="s1">&#39;taps&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">())</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">kv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">float</span><span class="p">(</span><span class="n">element</span><span class="p">[</span><span class="s1">&#39;kv&#39;</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">element</span><span class="p">[</span><span class="s1">&#39;kv.1&#39;</span><span class="p">])])</span>
                        <span class="n">kva</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">float</span><span class="p">(</span><span class="n">element</span><span class="p">[</span><span class="s1">&#39;kva&#39;</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">element</span><span class="p">[</span><span class="s1">&#39;kva.1&#39;</span><span class="p">])])</span>

                    <span class="k">if</span> <span class="s1">&#39;taps&#39;</span> <span class="ow">in</span> <span class="n">element</span><span class="p">:</span>
                        <span class="n">tap</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">element</span><span class="p">[</span><span class="s1">&#39;taps&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">())</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">tap</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">float</span><span class="p">(</span><span class="n">element</span><span class="p">[</span><span class="s1">&#39;tap&#39;</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">element</span><span class="p">[</span><span class="s1">&#39;tap.1&#39;</span><span class="p">])])</span>
                
                    <span class="bp">self</span><span class="o">.</span><span class="n">branches</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;kva&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kva</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">branches</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;tap&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tap</span>
                    <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">element</span><span class="p">[</span><span class="s1">&#39;phases&#39;</span><span class="p">])</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">branches</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;kv&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kv</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">branches</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;zbase&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">kv</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">)</span> <span class="o">/</span> <span class="n">kva</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">branches</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;kv&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kv</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">branches</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;zbase&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">kv</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">)</span> <span class="o">/</span> <span class="n">kva</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">branches</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;zeq&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">branches</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;%zeq&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mf">0.01</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">branches</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;zbase&#39;</span><span class="p">]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">branches</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;yeq&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">branches</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;zeq&#39;</span><span class="p">]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">branches</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;zkm&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">element</span><span class="p">[</span><span class="s1">&#39;phases&#39;</span><span class="p">]))</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">branches</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;zeq&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="c1"># secondary side impedance</span>

                    <span class="k">if</span> <span class="s1">&#39;conns&#39;</span> <span class="ow">in</span> <span class="n">element</span><span class="p">:</span>
                        <span class="n">conn1</span><span class="p">,</span> <span class="n">conn2</span> <span class="o">=</span> <span class="n">element</span><span class="p">[</span><span class="s1">&#39;conns&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
                    <span class="k">elif</span> <span class="s1">&#39;conn&#39;</span> <span class="ow">in</span> <span class="n">element</span><span class="p">:</span>
                        <span class="n">conn1</span><span class="p">,</span> <span class="n">conn2</span> <span class="o">=</span> <span class="n">element</span><span class="p">[</span><span class="s1">&#39;conn&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span> <span class="n">element</span><span class="p">[</span><span class="s1">&#39;conn.1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">branches</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;conn&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">conn1</span><span class="p">,</span> <span class="n">conn2</span><span class="p">]</span>

                    <span class="c1"># Filling weighted graph (weight is the tap multiplier)</span>
                    <span class="n">at</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">branches</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;tap&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">branches</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;tap&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">nt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">branches</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;kv&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">branches</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;kv&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">branches</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;akm&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">at</span>
                    <span class="c1">#self.branches[key][&#39;at&#39;] = at</span>
                    <span class="c1">#self.branches[key][&#39;nt&#39;] = nt</span>

                    <span class="n">weight</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">branches</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;tap&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">branches</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;kv&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">branches</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;kv&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">conn1</span> <span class="o">==</span> <span class="s1">&#39;wye&#39;</span> <span class="ow">and</span> <span class="n">conn2</span> <span class="o">==</span> <span class="s1">&#39;wye&#39;</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">branches</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;At&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nt</span><span class="o">*</span><span class="n">at</span> <span class="o">*</span>  <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">branches</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;phases&#39;</span><span class="p">])</span>
                    <span class="k">if</span> <span class="n">conn1</span> <span class="o">==</span> <span class="s1">&#39;wye&#39;</span> <span class="ow">and</span> <span class="n">conn2</span> <span class="o">==</span> <span class="s1">&#39;delta&#39;</span><span class="p">:</span>
                        <span class="n">weight</span> <span class="o">=</span> <span class="n">weight</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">e</span><span class="o">**</span> <span class="p">(</span><span class="mi">1</span><span class="n">j</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">6</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">branches</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;At&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">nt</span><span class="o">*</span><span class="n">at</span><span class="p">)</span><span class="o">/</span><span class="mi">3</span><span class="o">**</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">],[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]])</span>
                    <span class="k">elif</span> <span class="n">conn1</span> <span class="o">==</span> <span class="s1">&#39;delta&#39;</span> <span class="ow">and</span> <span class="n">conn2</span> <span class="o">==</span> <span class="s1">&#39;wye&#39;</span><span class="p">:</span>
                        <span class="n">weight</span> <span class="o">=</span> <span class="n">weight</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">e</span><span class="o">**</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="n">j</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">6</span><span class="p">)</span>                    
                        <span class="bp">self</span><span class="o">.</span><span class="n">branches</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;At&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">nt</span><span class="o">*</span><span class="n">at</span><span class="p">)</span><span class="o">/</span><span class="mi">3</span><span class="o">**</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">],[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]])</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">trbus1</span> <span class="o">+=</span> <span class="p">[</span><span class="n">bus1</span><span class="p">]</span> <span class="c1"># adding bus1 to list of primary buses</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">trbus2</span> <span class="o">+=</span> <span class="p">[</span><span class="n">bus2</span><span class="p">]</span>
                    
                <span class="bp">self</span><span class="o">.</span><span class="n">H</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">bus1</span><span class="p">,</span> <span class="n">bus2</span><span class="p">,</span> <span class="n">nodes1</span><span class="o">=</span><span class="n">nodes1</span><span class="p">,</span> <span class="n">nodes2</span><span class="o">=</span><span class="n">nodes2</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="n">weight</span><span class="p">,</span> <span class="n">id_</span><span class="o">=</span><span class="n">key</span><span class="p">)</span>
                                
                <span class="c1"># Parsing bus tags of the element and updating the entries of busnodes</span>
                <span class="c1"># The bus sequence is defined according to the order of the transformer and line branches </span>

                <span class="k">if</span> <span class="n">bus1</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">busnodes</span><span class="p">:</span> <span class="c1"># creating only new nodes in busnodes dict                    </span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">busnodes</span><span class="p">[</span><span class="n">bus1</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">busnodes</span><span class="p">[</span><span class="n">bus1</span><span class="p">][</span><span class="s1">&#39;nphases&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">element</span><span class="p">[</span><span class="s1">&#39;phases&#39;</span><span class="p">])</span> <span class="c1"># filling number of phases</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">busnodes</span><span class="p">[</span><span class="n">bus1</span><span class="p">][</span><span class="s1">&#39;nodes&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nodes1</span> <span class="c1"># filling nodes sequence</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">sys_nodes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">busnodes</span><span class="p">[</span><span class="n">bus1</span><span class="p">][</span><span class="s1">&#39;nodes&#39;</span><span class="p">]</span>
                    <span class="n">new_nodes</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">nodes1</span><span class="p">)</span><span class="o">-</span><span class="nb">set</span><span class="p">(</span><span class="n">sys_nodes</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">new_nodes</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">busnodes</span><span class="p">[</span><span class="n">bus1</span><span class="p">][</span><span class="s1">&#39;nodes&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">new_nodes</span><span class="p">))</span> <span class="c1"># filling missing nodes (TODO: Sort?)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">busnodes</span><span class="p">[</span><span class="n">bus1</span><span class="p">][</span><span class="s1">&#39;nphases&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">busnodes</span><span class="p">[</span><span class="n">bus1</span><span class="p">][</span><span class="s1">&#39;nodes&#39;</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">bus2</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">busnodes</span><span class="p">:</span> <span class="c1"># creating only new nodes in busnodes dict                    </span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">busnodes</span><span class="p">[</span><span class="n">bus2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">busnodes</span><span class="p">[</span><span class="n">bus2</span><span class="p">][</span><span class="s1">&#39;nphases&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">element</span><span class="p">[</span><span class="s1">&#39;phases&#39;</span><span class="p">])</span> <span class="c1"># filling number of phases</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">busnodes</span><span class="p">[</span><span class="n">bus2</span><span class="p">][</span><span class="s1">&#39;nodes&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nodes2</span> <span class="c1"># filling nodes sequence</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">sys_nodes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">busnodes</span><span class="p">[</span><span class="n">bus2</span><span class="p">][</span><span class="s1">&#39;nodes&#39;</span><span class="p">]</span>
                    <span class="n">new_nodes</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">nodes2</span><span class="p">)</span><span class="o">-</span><span class="nb">set</span><span class="p">(</span><span class="n">sys_nodes</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">new_nodes</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">busnodes</span><span class="p">[</span><span class="n">bus2</span><span class="p">][</span><span class="s1">&#39;nodes&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">new_nodes</span><span class="p">))</span> <span class="c1"># filling missing nodes (TODO: Sort?)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">busnodes</span><span class="p">[</span><span class="n">bus2</span><span class="p">][</span><span class="s1">&#39;nphases&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">busnodes</span><span class="p">[</span><span class="n">bus2</span><span class="p">][</span><span class="s1">&#39;nodes&#39;</span><span class="p">])</span>                    
                                                                   
        <span class="bp">self</span><span class="o">.</span><span class="n">nbus</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">busnodes</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nbr</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">branches</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trbus1</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trbus1</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trbus2</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trbus2</span><span class="p">))</span>

        <span class="n">cb</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># bus counter</span>
        <span class="n">cn</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># node counter</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">orderbus</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">orderbusn</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">bus</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">busnodes</span><span class="p">:</span>
            <span class="n">nodes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">busnodes</span><span class="p">[</span><span class="n">bus</span><span class="p">][</span><span class="s1">&#39;nodes&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">orderbus</span> <span class="o">+=</span> <span class="p">[</span><span class="n">bus</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">orderbusn</span> <span class="o">+=</span> <span class="p">[</span><span class="n">bus</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">nodes</span><span class="p">)]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">busnodes</span><span class="p">[</span><span class="n">bus</span><span class="p">][</span><span class="s1">&#39;bi&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cb</span><span class="p">;</span> <span class="n">cb</span> <span class="o">+=</span> <span class="mi">1</span> <span class="c1"># block index</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">busnodes</span><span class="p">[</span><span class="n">bus</span><span class="p">][</span><span class="s1">&#39;si&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cn</span> <span class="c1"># starting index of the bus            </span>
            <span class="bp">self</span><span class="o">.</span><span class="n">busnodes</span><span class="p">[</span><span class="n">bus</span><span class="p">][</span><span class="s1">&#39;inodes&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="o">*</span><span class="nb">range</span><span class="p">(</span><span class="n">cn</span><span class="p">,</span><span class="n">cn</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">nodes</span><span class="p">))]</span>
            <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">busnodes</span><span class="p">[</span><span class="n">bus</span><span class="p">][</span><span class="n">node</span><span class="p">]</span> <span class="o">=</span> <span class="n">cn</span><span class="p">;</span> <span class="n">cn</span> <span class="o">+=</span> <span class="mi">1</span> <span class="c1"># Adding keys to each node, e.g, &#39;1&#39;, &#39;2&#39; or &#39;3&#39; </span>

        <span class="bp">self</span><span class="o">.</span><span class="n">nnodes</span> <span class="o">=</span> <span class="n">cn</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">calc_Vbase</span><span class="p">()</span>  

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">times</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">times_data</span><span class="p">[</span><span class="s1">&#39;Construction of the bus-branch model ~ grid.busbranch()&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">t0</span></div>

<div class="viewcode-block" id="Powergrid.calc_Vbase"><a class="viewcode-back" href="../../pydse.html#pydse.powergrid.Powergrid.calc_Vbase">[docs]</a>    <span class="k">def</span> <span class="nf">calc_Vbase</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span><span class="c1"># Calculate vbase by traversing the order_fromsub graph</span>
        <span class="sd">&quot;&quot;&quot;Calculate the voltage bases for the system</span>

<span class="sd">        The method is based on the analysis of the network graph (sweepfromroot).</span>
<span class="sd">        Starting from the root node, each edge is traversed and the terminal-bus voltage</span>
<span class="sd">        base is computed by multiplying the other bus by the transformation ratio of the</span>
<span class="sd">        branch. For lines, this ratio is unitary. For transformers, it is defined based</span>
<span class="sd">        on the transformer ratio.</span>
<span class="sd">        &quot;&quot;&quot;</span>

         <span class="c1"># this is the forward edges list starting from the substation</span>
         <span class="c1"># It contains pairs (A,B) where the order is A -&gt; B</span>
         <span class="c1"># SRC should be in the first position (assumes a transformer connected at secondary)    </span>
         <span class="c1">#     </span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sweepfromroot</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">DiGraph</span><span class="p">(</span><span class="n">nx</span><span class="o">.</span><span class="n">topological_sort</span><span class="p">(</span><span class="n">nx</span><span class="o">.</span><span class="n">line_graph</span><span class="p">(</span><span class="n">nx</span><span class="o">.</span><span class="n">DiGraph</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">H</span><span class="p">))))</span>
      
        <span class="bp">self</span><span class="o">.</span><span class="n">initv</span> <span class="o">=</span> <span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">busnodes</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">initv</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">initv</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">initv</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">sub_bus</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">([</span><span class="s1">&#39;1&#39;</span><span class="p">,</span><span class="s1">&#39;2&#39;</span><span class="p">,</span><span class="s1">&#39;3&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">sub_angles</span><span class="p">)))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">vbase</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nnodes</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vbase</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">busnodes</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">sub_bus</span><span class="p">][</span><span class="s1">&#39;inodes&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sub_kv</span> <span class="o">*</span><span class="mi">1000</span>
        
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sweepfromroot</span><span class="o">.</span><span class="n">edges</span><span class="p">()):</span>

            <span class="n">npar</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">H</span><span class="o">.</span><span class="n">number_of_edges</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">m</span><span class="p">)</span> <span class="c1"># number of parallel branches between term1 and term2</span>
             
            <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">npar</span><span class="p">):</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">H</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">m</span><span class="p">][</span><span class="n">l</span><span class="p">][</span><span class="s1">&#39;nodes1&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">H</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">m</span><span class="p">][</span><span class="n">l</span><span class="p">][</span><span class="s1">&#39;nodes2&#39;</span><span class="p">]:</span> <span class="c1"># line or transformer in parallel with the same bus</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;calc_Vbase: branch terminals nodes are different&#39;</span><span class="p">)</span>
                    <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">id_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">H</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">m</span><span class="p">][</span><span class="n">l</span><span class="p">][</span><span class="s1">&#39;id_&#39;</span><span class="p">]</span>                
                <span class="n">nodes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">H</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">m</span><span class="p">][</span><span class="n">l</span><span class="p">][</span><span class="s1">&#39;nodes2&#39;</span><span class="p">]</span> <span class="c1"># assumes the TR primary and secondary phase sequences are equal !!      </span>
                <span class="n">w</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">H</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">m</span><span class="p">][</span><span class="n">l</span><span class="p">][</span><span class="s1">&#39;weight&#39;</span><span class="p">]</span>

                <span class="c1"># Initv is defined per wire</span>
                <span class="k">for</span> <span class="n">e</span><span class="p">,</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">nodes</span><span class="p">):</span>                 
                    <span class="bp">self</span><span class="o">.</span><span class="n">initv</span><span class="p">[</span><span class="n">m</span><span class="p">][</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">initv</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">n</span><span class="p">]</span> <span class="o">*</span> <span class="n">w</span>
                    <span class="k">if</span> <span class="s1">&#39;reg&#39;</span> <span class="ow">in</span> <span class="n">id_</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">vbase</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">busnodes</span><span class="p">[</span><span class="n">m</span><span class="p">][</span><span class="n">n</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vbase</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">busnodes</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">n</span><span class="p">]]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">vbase</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">busnodes</span><span class="p">[</span><span class="n">m</span><span class="p">][</span><span class="n">n</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vbase</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">busnodes</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">n</span><span class="p">]]</span> <span class="o">*</span> <span class="nb">abs</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>


        <span class="c1"># Print vector of voltage levels, if needed ..</span>
        <span class="k">if</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">np</span><span class="o">.</span><span class="n">set_printoptions</span><span class="p">(</span><span class="n">suppress</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">bus</span> <span class="p">,</span> <span class="n">vpunodes</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">initv</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="nb">print</span> <span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
                <span class="c1">#for v in range(len(value)):</span>
                <span class="k">for</span> <span class="n">ph</span><span class="p">,</span><span class="n">vpu</span> <span class="ow">in</span> <span class="n">vpunodes</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">angv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">angle</span><span class="p">(</span><span class="n">vpu</span><span class="p">)</span><span class="o">*</span><span class="mi">180</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span>
                    <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">angv</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">1e-12</span><span class="p">:</span>
                        <span class="n">angv</span> <span class="o">=</span> <span class="mf">0.</span>
                    <span class="nb">print</span> <span class="p">(</span><span class="s2">&quot;</span><span class="si">{:&gt;6g}</span><span class="s2"> </span><span class="si">{:s}</span><span class="s2"> </span><span class="si">{:&gt;4g}{:s}</span><span class="s2">    &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">vpu</span><span class="p">)</span>  <span class="p">,</span> 
                            <span class="sa">u</span><span class="s1">&#39;</span><span class="se">\u2220</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">angv</span> <span class="p">,</span> <span class="sa">u</span><span class="s1">&#39;</span><span class="se">\u00B0</span><span class="s1">&#39;</span><span class="p">),</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">()</span></div>



<div class="viewcode-block" id="Powergrid.build_Y"><a class="viewcode-back" href="../../pydse.html#pydse.powergrid.Powergrid.build_Y">[docs]</a>    <span class="k">def</span> <span class="nf">build_Y</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Builds the nodal admittance matrix</span>

<span class="sd">        The admittance matrix is first build considering a complete 3-phase system.</span>
<span class="sd">        &quot;&quot;&quot;</span>         
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">times</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">time</span>
            <span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

        <span class="c1"># Building string with the full node order (single-phase and two-phase become three)</span>
        <span class="n">ofull</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">orderbusn</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">virtn</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1">#[0] * (self.nbus*3) # indices of virtual nodes of orderbusn_full</span>
        <span class="k">for</span> <span class="n">o</span><span class="p">,</span> <span class="n">busstr</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ofull</span><span class="p">):</span>
            <span class="n">bus</span><span class="p">,</span> <span class="o">*</span><span class="n">nodes</span> <span class="o">=</span> <span class="n">busstr</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span> <span class="c1"># stripping bus string</span>
            <span class="n">nn</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">nodes</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">nn</span> <span class="o">&lt;</span> <span class="mi">3</span> <span class="p">:</span>
                <span class="n">phases</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;1&#39;</span><span class="p">,</span><span class="s1">&#39;2&#39;</span><span class="p">,</span><span class="s1">&#39;3&#39;</span><span class="p">]</span>                
                <span class="n">nodes</span> <span class="o">+=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">phases</span><span class="p">)</span><span class="o">-</span><span class="nb">set</span><span class="p">(</span><span class="n">nodes</span><span class="p">))</span>
                <span class="n">ofull</span><span class="p">[</span><span class="n">o</span><span class="p">]</span> <span class="o">=</span> <span class="n">bus</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">nodes</span><span class="p">)</span>
                <span class="c1">#virtn[3*o + nn : 3*o + 3 ] = [1]*(3-nn)</span>
                <span class="n">virtn</span> <span class="o">+=</span> <span class="p">[</span><span class="o">*</span><span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="n">o</span> <span class="o">+</span> <span class="n">nn</span><span class="p">,</span> <span class="mi">3</span><span class="o">*</span><span class="n">o</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)]</span>

        <span class="n">Y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">nbus</span><span class="o">*</span><span class="mi">3</span> <span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nbus</span><span class="o">*</span><span class="mi">3</span> <span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span> <span class="c1"># working with the full matrix (easier)</span>

        <span class="n">phases</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;1&#39;</span><span class="p">,</span><span class="s1">&#39;2&#39;</span><span class="p">,</span><span class="s1">&#39;3&#39;</span><span class="p">]</span>   

        <span class="k">for</span> <span class="n">id_</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">branches</span><span class="p">:</span>
            <span class="n">term1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">branches</span><span class="p">[</span><span class="n">id_</span><span class="p">][</span><span class="s1">&#39;bus1&#39;</span><span class="p">]</span>
            <span class="n">term1_nodes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">branches</span><span class="p">[</span><span class="n">id_</span><span class="p">][</span><span class="s1">&#39;nodes1&#39;</span><span class="p">]</span>
            <span class="n">term2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">branches</span><span class="p">[</span><span class="n">id_</span><span class="p">][</span><span class="s1">&#39;bus2&#39;</span><span class="p">]</span>
            <span class="n">term2_nodes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">branches</span><span class="p">[</span><span class="n">id_</span><span class="p">][</span><span class="s1">&#39;nodes2&#39;</span><span class="p">]</span>
            <span class="n">bus1_nodes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">busnodes</span><span class="p">[</span><span class="n">term1</span><span class="p">][</span><span class="s1">&#39;nodes&#39;</span><span class="p">]</span>
            <span class="n">bus2_nodes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">busnodes</span><span class="p">[</span><span class="n">term2</span><span class="p">][</span><span class="s1">&#39;nodes&#39;</span><span class="p">]</span>
            <span class="n">nel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">branches</span><span class="p">[</span><span class="n">id_</span><span class="p">][</span><span class="s1">&#39;phases&#39;</span><span class="p">]</span> <span class="c1"># number of phases elements</span>
            <span class="n">k</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">busnodes</span><span class="p">[</span><span class="n">term1</span><span class="p">][</span><span class="s1">&#39;bi&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">3</span> <span class="c1"># absolute position of bus k</span>
            <span class="n">m</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">busnodes</span><span class="p">[</span><span class="n">term2</span><span class="p">][</span><span class="s1">&#39;bi&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">3</span> <span class="c1"># absolute position of bus m</span>
            <span class="n">bus1_nodes</span> <span class="o">+=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">phases</span><span class="p">)</span><span class="o">-</span><span class="nb">set</span><span class="p">(</span><span class="n">bus1_nodes</span><span class="p">)))</span> <span class="c1"># always 3-phase</span>
            <span class="n">bus2_nodes</span> <span class="o">+=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">phases</span><span class="p">)</span><span class="o">-</span><span class="nb">set</span><span class="p">(</span><span class="n">bus2_nodes</span><span class="p">)))</span> <span class="c1"># always 3-phase</span>

            <span class="c1">############</span>
            <span class="c1"># Adding Transmission Lines</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">branches</span><span class="p">[</span><span class="n">id_</span><span class="p">][</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;line&#39;</span><span class="p">:</span>
                
                <span class="n">zkm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">branches</span><span class="p">[</span><span class="n">id_</span><span class="p">][</span><span class="s1">&#39;zkm&#39;</span><span class="p">]</span> <span class="c1"># branch&#39;s series impedance matrix between buses k and m</span>

                <span class="c1"># Normalizing</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sbase</span><span class="p">:</span>
                    <span class="n">vbase</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nel</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">p</span><span class="p">,</span> <span class="n">node</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">term1_nodes</span><span class="p">):</span>
                        <span class="n">n</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">busnodes</span><span class="p">[</span><span class="n">term1</span><span class="p">][</span><span class="n">node</span><span class="p">]</span>
                        <span class="n">vbase</span><span class="p">[</span><span class="n">p</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vbase</span><span class="p">[</span><span class="n">n</span><span class="p">]</span>               
                    <span class="n">zbase</span> <span class="o">=</span> <span class="p">(</span><span class="n">vbase</span> <span class="o">*</span> <span class="n">vbase</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">sbase</span>
                    <span class="n">zkm</span> <span class="o">=</span> <span class="n">zkm</span> <span class="o">/</span> <span class="n">zbase</span>
            
                <span class="n">ykm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">zkm</span><span class="p">)</span>
                    
                <span class="k">if</span> <span class="s1">&#39;cmatrix&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">branches</span><span class="p">[</span><span class="n">id_</span><span class="p">]:</span>
                    <span class="n">f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">branches</span><span class="p">[</span><span class="n">id_</span><span class="p">][</span><span class="s1">&#39;basefreq&#39;</span><span class="p">]</span>
                    <span class="n">bsh</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">pi</span> <span class="o">*</span> <span class="n">f</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">branches</span><span class="p">[</span><span class="n">id_</span><span class="p">][</span><span class="s1">&#39;cmatrix&#39;</span><span class="p">]</span> <span class="c1"># susceptance matrix</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sbase</span><span class="p">:</span>
                        <span class="n">xsh</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">bsh</span><span class="p">)</span>
                        <span class="n">xsh</span> <span class="o">=</span> <span class="n">xsh</span> <span class="o">/</span> <span class="n">zbase</span>
                        <span class="n">bsh</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">xsh</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">bsh</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">branches</span><span class="p">[</span><span class="n">id_</span><span class="p">][</span><span class="s1">&#39;rmatrix&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
                
                <span class="bp">self</span><span class="o">.</span><span class="n">branches</span><span class="p">[</span><span class="n">id_</span><span class="p">][</span><span class="s1">&#39;bsh&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bsh</span>
                  
                <span class="c1"># Resizing single and two-phase matrices to three-phases matrices</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">term1_nodes</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">bus1_nodes</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">term2_nodes</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">bus2_nodes</span><span class="p">):</span>                
                    <span class="n">term1_nodes</span> <span class="o">+=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">phases</span><span class="p">)</span><span class="o">-</span><span class="nb">set</span><span class="p">(</span><span class="n">term1_nodes</span><span class="p">)))</span>
                    <span class="n">term2_nodes</span> <span class="o">+=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">phases</span><span class="p">)</span><span class="o">-</span><span class="nb">set</span><span class="p">(</span><span class="n">term2_nodes</span><span class="p">)))</span>
                    <span class="c1"># Resizing series and shunt matrices</span>
                    <span class="n">ykm_f</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1e-20</span>
                    <span class="n">ykm_f</span><span class="p">[:</span><span class="n">nel</span><span class="p">,</span> <span class="p">:</span><span class="n">nel</span><span class="p">]</span> <span class="o">=</span> <span class="n">ykm</span>
                    <span class="n">ykm</span> <span class="o">=</span> <span class="n">ykm_f</span>
                    <span class="n">zkm_f</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1e+20</span>
                    <span class="n">zkm_f</span><span class="p">[:</span><span class="n">nel</span><span class="p">,</span> <span class="p">:</span><span class="n">nel</span><span class="p">]</span> <span class="o">=</span> <span class="n">zkm</span>
                    <span class="n">zkm</span> <span class="o">=</span> <span class="n">zkm_f</span>                    
                    <span class="n">bsh_f</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
                    <span class="n">bsh_f</span><span class="p">[:</span><span class="n">nel</span><span class="p">,</span> <span class="p">:</span><span class="n">nel</span><span class="p">]</span> <span class="o">=</span> <span class="n">bsh</span>
                    <span class="n">bsh</span> <span class="o">=</span> <span class="n">bsh_f</span>
                    
                <span class="n">Ykk</span> <span class="o">=</span> <span class="n">ykm</span> <span class="o">+</span> <span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="n">bsh</span><span class="o">/</span><span class="mi">2</span>
                <span class="n">Ymm</span> <span class="o">=</span> <span class="n">ykm</span> <span class="o">+</span> <span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="n">bsh</span><span class="o">/</span><span class="mi">2</span>
                <span class="n">Ykm</span> <span class="o">=</span> <span class="o">-</span><span class="n">ykm</span>
                <span class="n">Ymk</span> <span class="o">=</span> <span class="o">-</span><span class="n">ykm</span>

            <span class="c1">############</span>
            <span class="c1"># Adding Transformers</span>

            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">branches</span><span class="p">[</span><span class="n">id_</span><span class="p">][</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;transformer&#39;</span><span class="p">:</span>

                <span class="n">conn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">branches</span><span class="p">[</span><span class="n">id_</span><span class="p">][</span><span class="s1">&#39;conn&#39;</span><span class="p">]</span>
                <span class="n">n1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">branches</span><span class="p">[</span><span class="n">id_</span><span class="p">][</span><span class="s1">&#39;kv&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">branches</span><span class="p">[</span><span class="n">id_</span><span class="p">][</span><span class="s1">&#39;kv&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">n2</span> <span class="o">=</span> <span class="mf">1.</span>

                <span class="n">yeq1</span><span class="p">,</span> <span class="n">yeq2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">branches</span><span class="p">[</span><span class="n">id_</span><span class="p">][</span><span class="s1">&#39;yeq&#39;</span><span class="p">]</span>
                <span class="n">a1</span><span class="p">,</span> <span class="n">a2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">branches</span><span class="p">[</span><span class="n">id_</span><span class="p">][</span><span class="s1">&#39;tap&#39;</span><span class="p">]</span>

                <span class="c1"># Three-phase transformer</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">branches</span><span class="p">[</span><span class="n">id_</span><span class="p">][</span><span class="s1">&#39;phases&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>                  
                    <span class="n">YtrI</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> 
                    <span class="n">YtrII</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="mi">3</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">2</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">],[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">],[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">]])</span>
                    <span class="n">YtrIII</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="mi">3</span><span class="o">**</span><span class="mf">0.5</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">],[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">]])</span>

                    <span class="k">if</span> <span class="n">conn</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;wye&#39;</span> <span class="ow">and</span> <span class="n">conn</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;wye&#39;</span><span class="p">:</span>
                        <span class="n">Ykk</span> <span class="o">=</span>  <span class="n">YtrI</span> <span class="o">*</span> <span class="n">yeq2</span> <span class="o">/</span> <span class="p">(</span><span class="n">n1</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">a1</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="c1"># -&gt; * yeq1</span>
                        <span class="n">Ykm</span> <span class="o">=</span> <span class="o">-</span><span class="n">YtrI</span> <span class="o">*</span> <span class="n">yeq2</span> <span class="o">/</span> <span class="p">(</span><span class="n">n1</span><span class="o">*</span><span class="n">n2</span><span class="o">*</span><span class="n">a1</span><span class="o">*</span><span class="n">a2</span><span class="p">)</span>
                        <span class="n">Ymk</span> <span class="o">=</span> <span class="o">-</span><span class="n">YtrI</span> <span class="o">*</span> <span class="n">yeq2</span> <span class="o">/</span> <span class="p">(</span><span class="n">n1</span><span class="o">*</span><span class="n">n2</span><span class="o">*</span><span class="n">a1</span><span class="o">*</span><span class="n">a2</span><span class="p">)</span>
                        <span class="n">Ymm</span> <span class="o">=</span>  <span class="n">YtrI</span> <span class="o">*</span> <span class="n">yeq2</span> <span class="o">/</span> <span class="p">(</span><span class="n">n2</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">a2</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="c1"># -&gt; * yeq2</span>

                    <span class="k">elif</span> <span class="n">conn</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;wye&#39;</span> <span class="ow">and</span> <span class="n">conn</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;delta&#39;</span><span class="p">:</span>                    
                        <span class="n">Ykk</span> <span class="o">=</span>  <span class="n">YtrI</span> <span class="o">*</span> <span class="n">yeq2</span> <span class="o">/</span> <span class="p">(</span><span class="n">n1</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">a1</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
                        <span class="n">Ykm</span> <span class="o">=</span> <span class="n">YtrIII</span><span class="o">.</span><span class="n">T</span> <span class="o">*</span> <span class="n">yeq2</span> <span class="o">/</span> <span class="p">(</span><span class="n">n1</span><span class="o">*</span><span class="n">n2</span><span class="o">*</span><span class="n">a1</span><span class="o">*</span><span class="n">a2</span><span class="p">)</span>
                        <span class="n">Ymk</span> <span class="o">=</span> <span class="n">YtrIII</span> <span class="o">*</span> <span class="n">yeq2</span> <span class="o">/</span> <span class="p">(</span><span class="n">n1</span><span class="o">*</span><span class="n">n2</span><span class="o">*</span><span class="n">a1</span><span class="o">*</span><span class="n">a2</span><span class="p">)</span>
                        <span class="n">Ymm</span> <span class="o">=</span>  <span class="n">YtrII</span> <span class="o">*</span> <span class="n">yeq2</span> <span class="o">/</span> <span class="p">(</span><span class="n">n2</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">a2</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>                        

                    <span class="k">elif</span> <span class="n">conn</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;delta&#39;</span> <span class="ow">and</span> <span class="n">conn</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;wye&#39;</span><span class="p">:</span>
                        <span class="n">Ykk</span> <span class="o">=</span>  <span class="n">YtrII</span> <span class="o">*</span> <span class="n">yeq2</span> <span class="o">/</span> <span class="p">(</span><span class="n">n1</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">a1</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
                        <span class="n">Ykm</span> <span class="o">=</span> <span class="n">YtrIII</span> <span class="o">*</span> <span class="n">yeq2</span> <span class="o">/</span> <span class="p">(</span><span class="n">n1</span><span class="o">*</span><span class="n">n2</span><span class="o">*</span><span class="n">a1</span><span class="o">*</span><span class="n">a2</span><span class="p">)</span>
                        <span class="n">Ymk</span> <span class="o">=</span> <span class="n">YtrIII</span><span class="o">.</span><span class="n">T</span> <span class="o">*</span> <span class="n">yeq2</span> <span class="o">/</span> <span class="p">(</span><span class="n">n1</span><span class="o">*</span><span class="n">n2</span><span class="o">*</span><span class="n">a1</span><span class="o">*</span><span class="n">a2</span><span class="p">)</span>
                        <span class="n">Ymm</span> <span class="o">=</span>  <span class="n">YtrI</span> <span class="o">*</span> <span class="n">yeq2</span> <span class="o">/</span> <span class="p">(</span><span class="n">n2</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">a2</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

                    <span class="k">elif</span> <span class="n">conn</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;delta&#39;</span> <span class="ow">and</span> <span class="n">conn</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;delta&#39;</span><span class="p">:</span>
                        <span class="n">Ykk</span> <span class="o">=</span>  <span class="n">YtrII</span> <span class="o">*</span> <span class="n">yeq2</span> <span class="o">/</span> <span class="p">(</span><span class="n">n1</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">a1</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
                        <span class="n">Ykm</span> <span class="o">=</span> <span class="o">-</span><span class="n">YtrII</span><span class="o">.</span><span class="n">T</span> <span class="o">*</span> <span class="n">yeq2</span> <span class="o">/</span> <span class="p">(</span><span class="n">n1</span><span class="o">*</span><span class="n">n2</span><span class="o">*</span><span class="n">a1</span><span class="o">*</span><span class="n">a2</span><span class="p">)</span>
                        <span class="n">Ymk</span> <span class="o">=</span> <span class="o">-</span><span class="n">YtrII</span> <span class="o">*</span> <span class="n">yeq2</span> <span class="o">/</span> <span class="p">(</span><span class="n">n1</span><span class="o">*</span><span class="n">n2</span><span class="o">*</span><span class="n">a1</span><span class="o">*</span><span class="n">a2</span><span class="p">)</span>
                        <span class="n">Ymm</span> <span class="o">=</span>  <span class="n">YtrII</span> <span class="o">*</span> <span class="n">yeq2</span> <span class="o">/</span> <span class="p">(</span><span class="n">n2</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">a2</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">bus1_nodes</span> <span class="o">!=</span> <span class="n">term1_nodes</span> <span class="ow">or</span> <span class="n">bus2_nodes</span> <span class="o">!=</span> <span class="n">term2_nodes</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Can&#39;&#39;t permute transformer yet&#39;</span><span class="p">)</span>
                        <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

                <span class="c1"># Single-phase transformer</span>

                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">branches</span><span class="p">[</span><span class="n">id_</span><span class="p">][</span><span class="s1">&#39;phases&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>

                    <span class="n">term1_nodes</span> <span class="o">+=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">phases</span><span class="p">)</span><span class="o">-</span><span class="nb">set</span><span class="p">(</span><span class="n">term1_nodes</span><span class="p">)))</span>
                    <span class="n">term2_nodes</span> <span class="o">+=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">phases</span><span class="p">)</span><span class="o">-</span><span class="nb">set</span><span class="p">(</span><span class="n">term2_nodes</span><span class="p">)))</span>                       
                    <span class="n">ykm_f</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1e-20</span>
                    <span class="n">ykm_f</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">yeq2</span>
                    <span class="n">Ykk</span> <span class="o">=</span> <span class="n">ykm_f</span> <span class="o">/</span> <span class="p">(</span><span class="n">a1</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">n1</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
                    <span class="n">Ymm</span> <span class="o">=</span> <span class="n">ykm_f</span> <span class="o">/</span> <span class="p">(</span><span class="n">a2</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">n2</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
                    <span class="n">Ykm</span> <span class="o">=</span> <span class="o">-</span><span class="n">ykm_f</span> <span class="o">/</span> <span class="p">(</span><span class="n">n1</span><span class="o">*</span><span class="n">n2</span><span class="o">*</span><span class="n">a1</span><span class="o">*</span><span class="n">a2</span><span class="p">)</span>
                    <span class="n">Ymk</span> <span class="o">=</span> <span class="o">-</span><span class="n">ykm_f</span> <span class="o">/</span> <span class="p">(</span><span class="n">n1</span><span class="o">*</span><span class="n">n2</span><span class="o">*</span><span class="n">a1</span><span class="o">*</span><span class="n">a2</span><span class="p">)</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Can&#39;&#39;t handle two-phase transformers yet&#39;</span><span class="p">)</span>
                    <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

            <span class="c1"># Permutting the element phase sequence into the the bus phase sequence</span>

            <span class="k">if</span> <span class="n">bus1_nodes</span> <span class="o">!=</span> <span class="n">term1_nodes</span> <span class="ow">or</span> <span class="n">bus2_nodes</span> <span class="o">!=</span> <span class="n">term2_nodes</span><span class="p">:</span>
                <span class="c1"># If different order, reorder and permute matrix</span>
                <span class="n">np</span><span class="o">.</span><span class="n">set_printoptions</span><span class="p">(</span><span class="n">suppress</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">precision</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
                <span class="n">Yprim</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">Ykk</span><span class="p">,</span><span class="n">Ykm</span><span class="p">)),</span><span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">Ymk</span><span class="p">,</span><span class="n">Ymm</span><span class="p">))))</span>
                <span class="c1"># Convert node orderings to zero-indexed arrays</span>
                <span class="n">term1_nodes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span><span class="n">term1_nodes</span><span class="p">)))</span> <span class="o">-</span> <span class="mi">1</span>
                <span class="n">term2_nodes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span><span class="n">term2_nodes</span><span class="p">)))</span> <span class="o">-</span> <span class="mi">1</span>
                <span class="n">ok</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span><span class="n">bus1_nodes</span><span class="p">)))</span> <span class="o">-</span> <span class="mi">1</span> <span class="c1"># order of nodes in bus k (reference)</span>
                <span class="n">om</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span><span class="n">bus2_nodes</span><span class="p">)))</span> <span class="o">-</span> <span class="mi">1</span> <span class="c1"># order of nodes in bus m (reference)</span>
                <span class="c1"># Obtaining reverse permutation vectors:</span>
                <span class="n">rp_term1_nodes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
                <span class="n">rp_term2_nodes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
                    <span class="n">rp_term1_nodes</span><span class="p">[</span><span class="n">term1_nodes</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="n">i</span>
                    <span class="n">rp_term2_nodes</span><span class="p">[</span><span class="n">term2_nodes</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="n">i</span>                
                <span class="c1"># Obtaining new permutation vectors:</span>
                <span class="n">t1p</span> <span class="o">=</span> <span class="n">rp_term1_nodes</span><span class="p">[</span><span class="n">ok</span><span class="p">]</span>
                <span class="n">t2p</span> <span class="o">=</span> <span class="n">rp_term2_nodes</span><span class="p">[</span><span class="n">om</span><span class="p">]</span> <span class="o">+</span> <span class="mi">3</span>
                <span class="n">perm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">t1p</span><span class="p">,</span><span class="n">t2p</span><span class="p">))</span>
                <span class="c1"># Permute matrix and retrive submatrices</span>
                <span class="n">Yprim</span> <span class="o">=</span> <span class="n">Yprim</span><span class="p">[</span><span class="n">perm</span><span class="p">,:][:,</span><span class="n">perm</span><span class="p">]</span>
                <span class="n">Ykk</span> <span class="o">=</span> <span class="n">Yprim</span><span class="p">[:</span><span class="mi">3</span><span class="p">,:</span><span class="mi">3</span><span class="p">]</span>
                <span class="n">Ykm</span> <span class="o">=</span> <span class="n">Yprim</span><span class="p">[:</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">:]</span>
                <span class="n">Ymk</span> <span class="o">=</span> <span class="n">Yprim</span><span class="p">[</span><span class="mi">3</span><span class="p">:,:</span><span class="mi">3</span><span class="p">]</span>
                <span class="n">Ymm</span> <span class="o">=</span> <span class="n">Yprim</span><span class="p">[</span><span class="mi">3</span><span class="p">:,</span><span class="mi">3</span><span class="p">:]</span>           

            <span class="bp">self</span><span class="o">.</span><span class="n">branches</span><span class="p">[</span><span class="n">id_</span><span class="p">][</span><span class="s1">&#39;yprim&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">Ykk</span><span class="p">,</span><span class="n">Ykm</span><span class="p">)),</span><span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">Ymk</span><span class="p">,</span><span class="n">Ymm</span><span class="p">))))</span>

            <span class="n">Y</span><span class="p">[</span><span class="n">k</span><span class="p">:</span><span class="n">k</span><span class="o">+</span><span class="mi">3</span><span class="p">,</span><span class="n">k</span><span class="p">:</span><span class="n">k</span><span class="o">+</span><span class="mi">3</span><span class="p">]</span> <span class="o">+=</span> <span class="n">Ykk</span>
            <span class="n">Y</span><span class="p">[</span><span class="n">m</span><span class="p">:</span><span class="n">m</span><span class="o">+</span><span class="mi">3</span><span class="p">,</span><span class="n">m</span><span class="p">:</span><span class="n">m</span><span class="o">+</span><span class="mi">3</span><span class="p">]</span> <span class="o">+=</span> <span class="n">Ymm</span>
            <span class="n">Y</span><span class="p">[</span><span class="n">k</span><span class="p">:</span><span class="n">k</span><span class="o">+</span><span class="mi">3</span><span class="p">,</span><span class="n">m</span><span class="p">:</span><span class="n">m</span><span class="o">+</span><span class="mi">3</span><span class="p">]</span> <span class="o">+=</span> <span class="n">Ykm</span>
            <span class="n">Y</span><span class="p">[</span><span class="n">m</span><span class="p">:</span><span class="n">m</span><span class="o">+</span><span class="mi">3</span><span class="p">,</span><span class="n">k</span><span class="p">:</span><span class="n">k</span><span class="o">+</span><span class="mi">3</span><span class="p">]</span> <span class="o">+=</span> <span class="n">Ymk</span>
        
        <span class="c1"># Removing virtual nodes</span>
        <span class="n">non_virt</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="o">*</span><span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nbus</span><span class="o">*</span><span class="mi">3</span><span class="p">)])</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">virtn</span><span class="p">))</span>
        <span class="n">Y</span> <span class="o">=</span> <span class="n">Y</span><span class="p">[</span><span class="n">non_virt</span><span class="p">,:][:,</span><span class="n">non_virt</span><span class="p">]</span>        

        <span class="n">CAP_EPSILON</span> <span class="o">=</span> <span class="mi">1</span><span class="n">j</span><span class="o">*</span><span class="mf">4.2e-8</span> <span class="c1"># small capacitance to avoid open line (OpenDSS!!)</span>
        <span class="k">for</span> <span class="n">yy</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Y</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="n">Y</span><span class="p">[</span><span class="n">yy</span><span class="p">,</span><span class="n">yy</span><span class="p">]</span> <span class="o">+=</span> <span class="n">CAP_EPSILON</span>

        <span class="n">np</span><span class="o">.</span><span class="n">set_printoptions</span><span class="p">(</span><span class="n">precision</span><span class="o">=</span><span class="mi">9</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Y</span> <span class="o">=</span> <span class="n">Y</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">times</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">times_data</span><span class="p">[</span><span class="s1">&#39;Construction of the admittance matrix ~ grid.build_Y()&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">t0</span></div>


<div class="viewcode-block" id="Powergrid.init_E"><a class="viewcode-back" href="../../pydse.html#pydse.powergrid.Powergrid.init_E">[docs]</a>    <span class="k">def</span> <span class="nf">init_E</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mult</span><span class="o">=</span><span class="p">[</span><span class="mf">1.</span><span class="p">,</span><span class="mf">1.</span><span class="p">,</span><span class="mf">1.</span><span class="p">],</span> <span class="n">new</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialize line-to-neutral voltages</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        mult : array like, optional</span>
<span class="sd">            Multiplication factor to add to each phase magnitude, by default [1.,1.,1.]</span>
<span class="sd">        new : bool, by default True</span>
<span class="sd">            Activates the new initialization method, based on the network grapy</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">times</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">time</span>
            <span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

        <span class="n">vdic</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span> <span class="p">[[</span><span class="s1">&#39;1&#39;</span><span class="p">,</span> <span class="n">mult</span><span class="p">[</span><span class="mi">0</span><span class="p">]],[</span><span class="s1">&#39;2&#39;</span><span class="p">,</span><span class="n">mult</span><span class="p">[</span><span class="mi">1</span><span class="p">]],[</span><span class="s1">&#39;3&#39;</span><span class="p">,</span> <span class="n">mult</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span> <span class="p">])</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">new</span><span class="p">:</span> <span class="c1"># (old method)</span>
            
            <span class="n">sub_kv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sub_kv</span><span class="o">*</span><span class="mi">1000</span><span class="o">/</span><span class="p">(</span><span class="mi">3</span><span class="o">**</span><span class="mf">0.5</span><span class="p">)</span>
            <span class="n">sube</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;1&#39;</span> <span class="p">:</span> <span class="n">sub_kv</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">sub_angles</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> 
                    <span class="s1">&#39;2&#39;</span> <span class="p">:</span> <span class="n">sub_kv</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">sub_angles</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> 
                    <span class="s1">&#39;3&#39;</span> <span class="p">:</span> <span class="n">sub_kv</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">sub_angles</span><span class="p">[</span><span class="mi">2</span><span class="p">]}</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">E</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nnodes</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">bus</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">busnodes</span><span class="p">:</span>
                <span class="n">nodes</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">busnodes</span><span class="p">[</span><span class="n">bus</span><span class="p">][</span><span class="s1">&#39;nodes&#39;</span><span class="p">])</span>
                <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">:</span>
                    <span class="n">k</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">busnodes</span><span class="p">[</span><span class="n">bus</span><span class="p">][</span><span class="n">node</span><span class="p">]</span> <span class="c1"># position of the node in E</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">E</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">sube</span><span class="p">[</span><span class="n">node</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">bus</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sub_bus</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">E</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">E</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">*</span> <span class="n">vdic</span><span class="p">[</span><span class="n">node</span><span class="p">]</span>                      
        <span class="k">else</span><span class="p">:</span>
            
            <span class="c1"># Initialize based on the voltage levels (Calc_Vbases)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">E</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nnodes</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">bus</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">busnodes</span><span class="p">:</span>
                <span class="n">nodes</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">busnodes</span><span class="p">[</span><span class="n">bus</span><span class="p">][</span><span class="s1">&#39;nodes&#39;</span><span class="p">])</span>
                <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">:</span>
                    <span class="n">k</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">busnodes</span><span class="p">[</span><span class="n">bus</span><span class="p">][</span><span class="n">node</span><span class="p">]</span> <span class="c1"># position of the node in E</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">E</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">initv</span><span class="p">[</span><span class="n">bus</span><span class="p">][</span><span class="n">node</span><span class="p">]</span>
            
            <span class="c1"># Initiv only has the relation between bases</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">E</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">E</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">sub_kv</span><span class="o">*</span><span class="mi">1000</span><span class="o">/</span><span class="p">(</span><span class="mi">3</span><span class="o">**</span><span class="mf">0.5</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sbase</span><span class="p">:</span> 
                <span class="bp">self</span><span class="o">.</span><span class="n">E</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">E</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vbase</span><span class="o">/</span> <span class="mi">3</span><span class="o">**</span><span class="mf">0.5</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">times</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">times_data</span><span class="p">[</span><span class="s1">&#39;Voltage initialization ~ grid.init_E()&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">t0</span></div>


<div class="viewcode-block" id="Powergrid.reorder_e"><a class="viewcode-back" href="../../pydse.html#pydse.powergrid.Powergrid.reorder_e">[docs]</a>    <span class="k">def</span> <span class="nf">reorder_e</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">orderbusn</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Compute a new (reordered) voltage vector and voltage base </span>

<span class="sd">        The new bus order is provided as a list (orderbusn) with buses and nodes.</span>
<span class="sd">        The class voltage vector (self.E) is not modified</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        orderbusn : list of buses and nodes (of kind &#39;bus.1.2.3&#39;)</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        E, array like</span>
<span class="sd">            Reorderd voltage vector</span>
<span class="sd">        vbase, array like</span>
<span class="sd">            Reorderd vbase list</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">E</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nnodes</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span> <span class="c1"># new phase-to-neutral voltage vector       </span>
        <span class="n">vbase</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nnodes</span><span class="p">)</span>
        <span class="n">ce</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">busn</span> <span class="ow">in</span> <span class="n">orderbusn</span><span class="p">:</span>
            <span class="n">bus</span><span class="p">,</span> <span class="o">*</span><span class="n">nodes</span> <span class="o">=</span> <span class="n">busn</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span> <span class="c1"># stripping bus string        </span>
            <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">:</span>
                <span class="n">k</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">busnodes</span><span class="p">[</span><span class="n">bus</span><span class="p">][</span><span class="n">node</span><span class="p">]</span> <span class="c1"># position of node in node list</span>
                <span class="n">E</span><span class="p">[</span><span class="n">ce</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">E</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
                <span class="n">vbase</span><span class="p">[</span><span class="n">ce</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vbase</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
                <span class="n">ce</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">return</span> <span class="p">(</span><span class="n">E</span><span class="p">,</span> <span class="n">vbase</span><span class="p">)</span></div>


<div class="viewcode-block" id="Powergrid.calc_Ell"><a class="viewcode-back" href="../../pydse.html#pydse.powergrid.Powergrid.calc_Ell">[docs]</a>    <span class="k">def</span> <span class="nf">calc_Ell</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Calculate line-to-line voltages</span>
<span class="sd">        </span>
<span class="sd">        The line-to-line voltages are computed based on the line-to neutral voltages</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Ell</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">cel</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># counter of line voltages inserted</span>
        <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nbus</span><span class="p">):</span>
            <span class="n">bus</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">orderbusn</span><span class="p">[</span><span class="n">b</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">nph</span> <span class="o">=</span> <span class="nb">int</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">busnodes</span><span class="p">[</span><span class="n">bus</span><span class="p">][</span><span class="s1">&#39;nphases&#39;</span><span class="p">])</span>          
            <span class="n">nell</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">nph</span><span class="o">*</span><span class="n">nph</span> <span class="o">-</span> <span class="n">nph</span><span class="p">))</span> <span class="c1"># number of line-to-line voltages</span>
            <span class="n">ell</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nell</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span> <span class="c1"># array of line-to-line voltages           </span>
            <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nell</span><span class="p">):</span>
                <span class="n">ell</span><span class="p">[</span><span class="n">e</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">E</span><span class="p">[</span><span class="n">cel</span><span class="o">+</span><span class="n">e</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">E</span><span class="p">[</span><span class="n">cel</span><span class="o">+</span><span class="p">((</span><span class="n">e</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">%</span><span class="mi">3</span><span class="p">)]</span>
            <span class="n">ell</span><span class="p">[</span><span class="n">nell</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span> 
            <span class="n">cel</span> <span class="o">+=</span> <span class="n">nell</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Ell</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">Ell</span><span class="p">,</span><span class="n">ell</span><span class="p">))</span></div>


<div class="viewcode-block" id="Powergrid.calc_Il"><a class="viewcode-back" href="../../pydse.html#pydse.powergrid.Powergrid.calc_Il">[docs]</a>    <span class="k">def</span> <span class="nf">calc_Il</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">E</span><span class="o">=</span><span class="p">[],</span> <span class="n">loadmodel</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span> <span class="c1"># calculates load and capacitor currents</span>
        <span class="sd">&quot;&quot;&quot;Calculates the currents drawn by loads and shunt capacitors</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        E : array like, optional</span>
<span class="sd">            Nodal voltage vector. If not provided, self.E is assumed</span>
<span class="sd">        loadmodel : {&#39;1&#39;, &#39;2&#39;, &#39;5&#39;}, optional</span>
<span class="sd">            Load model to assume for all loads. If provided, overrides the individual load models.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">times</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">time</span>
            <span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">E</span><span class="p">):</span>
            <span class="n">E</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">E</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">Il</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">nnodes</span> <span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span> <span class="p">)</span>

        <span class="k">for</span> <span class="n">id_</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">load</span><span class="p">:</span>

            <span class="n">bus</span><span class="p">,</span> <span class="o">*</span><span class="n">nodes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load</span><span class="p">[</span><span class="n">id_</span><span class="p">][</span><span class="s1">&#39;bus1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span> <span class="c1"># stripping bus string</span>
            <span class="n">nphases</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">load</span><span class="p">[</span><span class="n">id_</span><span class="p">][</span><span class="s1">&#39;phases&#39;</span><span class="p">])</span>
            <span class="k">if</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">nodes</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">):</span>
                <span class="n">nodes</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="s1">&#39;123&#39;</span><span class="p">[:</span><span class="n">nphases</span><span class="p">])</span>

            <span class="n">net_kw</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">load</span><span class="p">[</span><span class="n">id_</span><span class="p">][</span><span class="s1">&#39;kw&#39;</span><span class="p">])</span>
            <span class="n">net_kvar</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">load</span><span class="p">[</span><span class="n">id_</span><span class="p">][</span><span class="s1">&#39;kvar&#39;</span><span class="p">])</span>
            <span class="n">va</span> <span class="o">=</span> <span class="p">(</span><span class="n">net_kw</span> <span class="o">+</span> <span class="mi">1</span><span class="n">j</span><span class="o">*</span><span class="n">net_kvar</span><span class="p">)</span><span class="o">*</span><span class="mi">1000</span> <span class="o">/</span> <span class="n">nphases</span>
            
            <span class="k">if</span> <span class="s1">&#39;*&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">load</span><span class="p">[</span><span class="n">id_</span><span class="p">][</span><span class="s1">&#39;kv&#39;</span><span class="p">]:</span>
                <span class="n">mult</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load</span><span class="p">[</span><span class="n">id_</span><span class="p">][</span><span class="s1">&#39;kv&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
                <span class="n">kv</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">mult</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="nb">float</span><span class="p">(</span><span class="n">mult</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">kv</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">load</span><span class="p">[</span><span class="n">id_</span><span class="p">][</span><span class="s1">&#39;kv&#39;</span><span class="p">])</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sbase</span><span class="p">:</span>
                <span class="n">va</span> <span class="o">=</span> <span class="n">va</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sbase</span><span class="p">)</span>
            
            <span class="c1">#k = self.busnodes[bus][&#39;si&#39;] # start position of the bus in the system node list</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">loadmodel</span><span class="p">:</span>
                <span class="n">loadmodel_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load</span><span class="p">[</span><span class="n">id_</span><span class="p">][</span><span class="s1">&#39;model&#39;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">loadmodel_</span> <span class="o">=</span> <span class="n">loadmodel</span>
           
            <span class="c1">###########################</span>
            <span class="c1"># Wye-connected load</span>
            <span class="c1">#</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">load</span><span class="p">[</span><span class="n">id_</span><span class="p">][</span><span class="s1">&#39;conn&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Wye&#39;</span> <span class="p">:</span>

                <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">:</span>

                    <span class="n">k</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">busnodes</span><span class="p">[</span><span class="n">bus</span><span class="p">][</span><span class="n">node</span><span class="p">]</span> <span class="c1"># position of node in node list                        </span>

                    <span class="c1"># Constant Power </span>
                    <span class="k">if</span> <span class="n">loadmodel_</span> <span class="o">==</span> <span class="s1">&#39;1&#39;</span> <span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">Il</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">-=</span> <span class="n">np</span><span class="o">.</span><span class="n">conj</span><span class="p">(</span><span class="n">va</span> <span class="o">/</span> <span class="n">E</span><span class="p">[</span><span class="n">k</span><span class="p">])</span> <span class="c1">#+ Iy</span>

                    <span class="c1"># Constant Impedance model</span>
                    <span class="k">elif</span> <span class="n">loadmodel_</span> <span class="o">==</span> <span class="s1">&#39;2&#39;</span> <span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">Il</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">-=</span> <span class="n">np</span><span class="o">.</span><span class="n">conj</span><span class="p">(</span><span class="n">va</span><span class="p">)</span> <span class="o">*</span> <span class="n">E</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">/</span> <span class="p">((</span><span class="n">kv</span><span class="o">*</span><span class="mi">1000</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="c1"># adding current of load node k to Ik</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sbase</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">Il</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Il</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vbase</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">/</span><span class="mi">3</span><span class="o">**</span><span class="mf">0.5</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>

                    <span class="c1"># Constant Current model</span>
                    <span class="k">elif</span> <span class="n">loadmodel_</span> <span class="o">==</span> <span class="s1">&#39;5&#39;</span> <span class="p">:</span>
                        <span class="n">Imag</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">va</span><span class="p">)</span><span class="o">/</span><span class="p">((</span><span class="n">kv</span><span class="o">*</span><span class="mi">1000</span><span class="p">))</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sbase</span><span class="p">:</span>
                            <span class="n">Imag</span> <span class="o">=</span> <span class="n">Imag</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vbase</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">/</span><span class="mi">3</span><span class="o">**</span><span class="mf">0.5</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">Il</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">-=</span> <span class="n">Imag</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">e</span><span class="o">**</span><span class="p">(</span><span class="mi">1</span><span class="n">j</span><span class="o">*</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">angle</span><span class="p">(</span><span class="n">E</span><span class="p">[</span><span class="n">k</span><span class="p">])</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">angle</span><span class="p">(</span><span class="n">va</span><span class="p">)))</span>


            <span class="c1">###########################</span>
            <span class="c1"># Delta-connected load</span>
            <span class="c1">#</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">load</span><span class="p">[</span><span class="n">id_</span><span class="p">][</span><span class="s1">&#39;conn&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Delta&#39;</span> <span class="p">:</span>
                
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nphases</span><span class="p">):</span>
                    <span class="n">node1</span> <span class="o">=</span> <span class="n">nodes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="c1"># string of node i</span>
                    <span class="n">node2</span> <span class="o">=</span> <span class="n">nodes</span><span class="p">[</span><span class="nb">int</span><span class="p">((</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">%</span><span class="mi">3</span><span class="p">)]</span>
                    <span class="n">f</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">node1</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span> <span class="c1"># bus1 integer index</span>
                    <span class="n">t</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">node2</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span> <span class="c1"># bus2 integer index</span>
                    <span class="n">fi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">busnodes</span><span class="p">[</span><span class="n">bus</span><span class="p">][</span><span class="n">node1</span><span class="p">]</span> <span class="c1"># from bus index in node list</span>
                    <span class="n">ti</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">busnodes</span><span class="p">[</span><span class="n">bus</span><span class="p">][</span><span class="n">node2</span><span class="p">]</span> <span class="c1"># to bus index in node list</span>

                    <span class="c1"># Constant Power model</span>
                    <span class="k">if</span> <span class="n">loadmodel_</span> <span class="o">==</span> <span class="s1">&#39;1&#39;</span> <span class="p">:</span>     
                        <span class="n">iphase</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">conj</span><span class="p">(</span><span class="n">va</span> <span class="o">/</span> <span class="p">(</span><span class="n">E</span><span class="p">[</span><span class="n">fi</span><span class="p">]</span> <span class="o">-</span> <span class="n">E</span><span class="p">[</span><span class="n">ti</span><span class="p">]))</span>              

                    <span class="c1"># Constant Impedance model </span>
                    <span class="k">elif</span> <span class="n">loadmodel_</span> <span class="o">==</span> <span class="s1">&#39;2&#39;</span> <span class="p">:</span>
                        <span class="n">iphase</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">conj</span><span class="p">(</span><span class="n">va</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">E</span><span class="p">[</span><span class="n">fi</span><span class="p">]</span> <span class="o">-</span> <span class="n">E</span><span class="p">[</span><span class="n">ti</span><span class="p">])</span> <span class="o">/</span> <span class="p">((</span><span class="n">kv</span><span class="o">*</span><span class="mi">1000</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sbase</span><span class="p">:</span>
                            <span class="n">iphase</span> <span class="o">=</span> <span class="n">iphase</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vbase</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">/</span><span class="mi">3</span><span class="o">**</span><span class="mf">0.5</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>

                    <span class="c1"># Constant Current model </span>
                    <span class="k">elif</span> <span class="n">loadmodel_</span> <span class="o">==</span> <span class="s1">&#39;5&#39;</span> <span class="p">:</span>
                        <span class="n">Imag</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">va</span><span class="p">)</span><span class="o">/</span><span class="p">((</span><span class="n">kv</span><span class="o">*</span><span class="mi">1000</span><span class="p">))</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sbase</span><span class="p">:</span>
                            <span class="n">Imag</span> <span class="o">=</span> <span class="n">Imag</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vbase</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">/</span><span class="mi">3</span><span class="o">**</span><span class="mf">0.5</span><span class="p">)</span>                        
                        <span class="n">iphase</span> <span class="o">=</span> <span class="n">Imag</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">e</span><span class="o">**</span><span class="p">(</span><span class="mi">1</span><span class="n">j</span><span class="o">*</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">angle</span><span class="p">(</span><span class="n">E</span><span class="p">[</span><span class="n">fi</span><span class="p">]</span> <span class="o">-</span> <span class="n">E</span><span class="p">[</span><span class="n">ti</span><span class="p">])</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">angle</span><span class="p">(</span><span class="n">va</span><span class="p">)))</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">Il</span><span class="p">[</span><span class="n">fi</span><span class="p">]</span> <span class="o">-=</span> <span class="n">iphase</span> <span class="c1"># accumulating phase current at node fi</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">Il</span><span class="p">[</span><span class="n">ti</span><span class="p">]</span> <span class="o">+=</span> <span class="n">iphase</span>
                
        <span class="bp">self</span><span class="o">.</span><span class="n">Ic</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nnodes</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">id_</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">capacitor</span><span class="p">:</span>
            <span class="n">bus</span><span class="p">,</span> <span class="o">*</span><span class="n">nodes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">capacitor</span><span class="p">[</span><span class="n">id_</span><span class="p">][</span><span class="s1">&#39;bus1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
            <span class="n">nph</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">capacitor</span><span class="p">[</span><span class="n">id_</span><span class="p">][</span><span class="s1">&#39;phases&#39;</span><span class="p">])</span>
            <span class="n">kvar</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">capacitor</span><span class="p">[</span><span class="n">id_</span><span class="p">][</span><span class="s1">&#39;kvar&#39;</span><span class="p">])</span> <span class="o">/</span> <span class="n">nph</span> <span class="c1"># kvar of single capacitor</span>
            <span class="n">kv</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">capacitor</span><span class="p">[</span><span class="n">id_</span><span class="p">][</span><span class="s1">&#39;kv&#39;</span><span class="p">])</span>          
            <span class="k">if</span> <span class="n">nph</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">or</span> <span class="n">nph</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                <span class="n">kv</span> <span class="o">=</span> <span class="n">kv</span> <span class="o">/</span> <span class="p">(</span><span class="mi">3</span><span class="o">**</span><span class="mf">0.5</span><span class="p">)</span>

            <span class="n">bc</span> <span class="o">=</span> <span class="p">(</span> <span class="n">kvar</span> <span class="o">/</span> <span class="p">(</span><span class="n">kv</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">)</span> <span class="p">)</span> <span class="c1"># Susceptance (Siemens)</span>

            <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">:</span>
                <span class="n">k</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">busnodes</span><span class="p">[</span><span class="n">bus</span><span class="p">][</span><span class="n">node</span><span class="p">]</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sbase</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">nph</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">bc</span> <span class="o">=</span> <span class="n">bc</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vbase</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sbase</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">bc</span> <span class="o">=</span> <span class="n">bc</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vbase</span><span class="p">[</span><span class="n">k</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span>  <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sbase</span><span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">Ic</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">-=</span> <span class="mi">1</span><span class="n">j</span><span class="o">*</span> <span class="n">bc</span> <span class="o">*</span> <span class="n">E</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> 

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">times</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">times_data</span><span class="p">[</span><span class="s1">&#39;Calculation of current injections ~ loadflow.calc_Il()&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">t0</span></div>
                
    
<div class="viewcode-block" id="Powergrid.flowsAndInjections"><a class="viewcode-back" href="../../pydse.html#pydse.powergrid.Powergrid.flowsAndInjections">[docs]</a>    <span class="k">def</span> <span class="nf">flowsAndInjections</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Calculate current/power flows and injections</span>

<span class="sd">            This method calculates both current and power flows and injections,</span>
<span class="sd">            based on the available complex voltages</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">times</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">time</span>
            <span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">I</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Y</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">E</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">S</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">E</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">conjugate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">I</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Ikm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nbrp</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Skm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nbrp</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>

        <span class="c1"># Python &gt;= 3.6</span>
        <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c1">#for branch in self.branches:</span>
        <span class="k">for</span>  <span class="n">branch</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">branches</span><span class="p">:</span>
            <span class="n">nph</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">branches</span><span class="p">[</span><span class="n">branch</span><span class="p">][</span><span class="s1">&#39;phases&#39;</span><span class="p">]</span>

            <span class="n">k</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">branches</span><span class="p">[</span><span class="n">branch</span><span class="p">][</span><span class="s1">&#39;bus1&#39;</span><span class="p">]</span>
            <span class="n">m</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">branches</span><span class="p">[</span><span class="n">branch</span><span class="p">][</span><span class="s1">&#39;bus2&#39;</span><span class="p">]</span>
            <span class="n">knodes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">branches</span><span class="p">[</span><span class="n">branch</span><span class="p">][</span><span class="s1">&#39;nodes1&#39;</span><span class="p">]</span>
            <span class="n">mnodes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">branches</span><span class="p">[</span><span class="n">branch</span><span class="p">][</span><span class="s1">&#39;nodes2&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">knodes</span> <span class="o">!=</span> <span class="n">mnodes</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;flowsAndInjections: knodes and mnodes are different! &#39;</span><span class="p">)</span>
                <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

            <span class="c1"># Nodes indexes in the actual bus nodes</span>
            <span class="n">iknodes</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">busnodes</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;nodes&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">knodes</span><span class="p">]</span>
            <span class="n">imnodes</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">busnodes</span><span class="p">[</span><span class="n">m</span><span class="p">][</span><span class="s1">&#39;nodes&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">mnodes</span><span class="p">]</span>
            <span class="c1"># Node indexes in the voltage vector</span>
            <span class="n">ik</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">busnodes</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;inodes&#39;</span><span class="p">])[</span><span class="n">iknodes</span><span class="p">]</span>
            <span class="n">im</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">busnodes</span><span class="p">[</span><span class="n">m</span><span class="p">][</span><span class="s1">&#39;inodes&#39;</span><span class="p">])[</span><span class="n">imnodes</span><span class="p">]</span>
            <span class="n">Ek</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">E</span><span class="p">[</span><span class="n">ik</span><span class="p">]</span>
            <span class="n">Em</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">E</span><span class="p">[</span><span class="n">im</span><span class="p">]</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">branches</span><span class="p">[</span><span class="n">branch</span><span class="p">][</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;line&#39;</span><span class="p">:</span>
                <span class="n">ykm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">branches</span><span class="p">[</span><span class="n">branch</span><span class="p">][</span><span class="s1">&#39;ykm&#39;</span><span class="p">]</span>
                <span class="n">ikm</span> <span class="o">=</span> <span class="n">ykm</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Ek</span> <span class="o">-</span> <span class="n">Em</span><span class="p">)</span>                
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">branches</span><span class="p">[</span><span class="n">branch</span><span class="p">][</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;transformer&#39;</span><span class="p">:</span>
                <span class="n">Yp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">branches</span><span class="p">[</span><span class="n">branch</span><span class="p">][</span><span class="s1">&#39;yprim&#39;</span><span class="p">]</span>
                <span class="n">ik_bus</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">busnodes</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;inodes&#39;</span><span class="p">]</span>
                <span class="n">im_bus</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">busnodes</span><span class="p">[</span><span class="n">m</span><span class="p">][</span><span class="s1">&#39;inodes&#39;</span><span class="p">]</span>
                <span class="n">Ip</span> <span class="o">=</span> <span class="n">Yp</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">E</span><span class="p">[</span><span class="n">ik_bus</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">E</span><span class="p">[</span><span class="n">im_bus</span><span class="p">])))</span>
                <span class="c1">#ikm = -Ip[3:] # currents flowing out of the secondary side</span>
                <span class="n">ikm</span> <span class="o">=</span> <span class="o">-</span><span class="n">Ip</span><span class="p">[</span><span class="mi">3</span><span class="p">:][</span><span class="n">imnodes</span><span class="p">]</span>
                <span class="n">Ek</span> <span class="o">=</span> <span class="n">Em</span> <span class="c1"># voltage is at the secondary side</span>

            <span class="n">skm</span> <span class="o">=</span> <span class="n">Ek</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">conjugate</span> <span class="p">(</span><span class="n">ikm</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Ikm</span><span class="p">[</span><span class="n">j</span><span class="p">:</span><span class="n">j</span><span class="o">+</span><span class="n">nph</span><span class="p">]</span> <span class="o">=</span> <span class="n">ikm</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Skm</span><span class="p">[</span><span class="n">j</span><span class="p">:</span><span class="n">j</span><span class="o">+</span><span class="n">nph</span><span class="p">]</span> <span class="o">=</span> <span class="n">skm</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">branches</span><span class="p">[</span><span class="n">branch</span><span class="p">][</span><span class="s1">&#39;ikm&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ikm</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">branches</span><span class="p">[</span><span class="n">branch</span><span class="p">][</span><span class="s1">&#39;skm&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">skm</span>            

            <span class="n">j</span> <span class="o">+=</span> <span class="n">nph</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">times</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">times_data</span><span class="p">[</span><span class="s1">&#39;Calculation of flows and injections ~ loadflow.flowsAndInjections()&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">t0</span></div></div>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, Eduardo Werley.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>